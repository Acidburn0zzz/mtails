#!/bin/sh

set -e

if ! grep -qs 'ref:' /amnesia.git/.git/HEAD; then
	tag="$(git --git-dir=/amnesia.git/.git/ describe --tags --exact-match HEAD 2>/dev/null)"
	if [ ! -z "${tag}"Â ]; then
		current_head_name="${tag}"
	else
		current_head_name="$(cat /amnesia.git/.git/HEAD)"
	fi
else
	current_head_name="$(git --git-dir=/amnesia.git/.git/ rev-parse --abbrev-ref HEAD)"
fi


if [ ! -f /var/lib/vagrant_box_build_from ]; then
	echo "${current_head_name}" > /var/lib/vagrant_box_build_from
else
	if [ "$(cat /var/lib/vagrant_box_build_from)" != "${current_head_name}" ]; then
		echo "E: The current VM has been created to build $(cat /var/lib/vagrant_box_build_from)."
		echo "E: Please first use rake vm:destroy before trying to build again."
		exit 1
	fi
fi

export DEBIAN_FRONTEND=noninteractive

# Do not use virtual machine proxy before apt-cacher-ng is installed
if [ "$http_proxy" = "http://$(hostname -f):3142" ] &&
   ! [ -f /etc/apt-cacher-ng/acng.conf ]; then
	LOCAL_HTTP_PROXY="$http_proxy"
	http_proxy=''
fi

# Store basebox serial before regenerating APT sources
stable_serial="$(grep -Po '\d{10}' /etc/apt/sources.list)"

latest_serial(){
	local archive="${1}"
	get_serial="$(/amnesia.git/auto/scripts/apt-snapshots-serials get-latest ${archive})"
	echo "${get_serial#${1}: }"
}

# Set the APT repo sources depending on the branch
base_branch="$(cat /amnesia.git/config/base_branch)"

case "${base_branch}" in
	devel|testing|feature/stretch)
		serial="$(latest_serial debian)"
		sed -i -e "s/${stable_serial}/${serial}/g" /etc/apt/sources.list
		# We need a newer version of debootstrap for saving the list of
		# packages used when building Tails (#6297).
		sed -i -e "s/${stable_serial}/${serial}/g" /etc/apt/sources.list.d/jessie-backports.list
esac

# Always set the latest serial for debian-security
security_serial="$(latest_serial debian-security)"
sed -i -e "s/${stable_serial}/${security_serial}/g" /etc/apt/sources.list.d/jessie-updates.list

apt-get update
apt-get -o Dpkg::Options::="--force-confold" -y install apt-cacher-ng

# Install custom configuration for apt-cacher-ng and restart
install -o root -g root -m 644 /vagrant/provision/assets/acng.conf /etc/apt-cacher-ng/acng.conf
service apt-cacher-ng restart

# Restore local HTTP proxy if needed
if [ "$LOCAL_HTTP_PROXY" ]; then
	http_proxy="$LOCAL_HTTP_PROXY"
fi

# Upgrade if needed
apt-get -y dist-upgrade

# Those are needed to build Tails
apt-get -y install \
        debootstrap/jessie-backports \
        git \
        dpkg-dev \
        eatmydata \
        gettext \
        ikiwiki \
        intltool \
        libfile-slurp-perl \
        liblist-moreutils-perl \
        live-build \
        rsync \
        syslinux-utils \
        time \
        whois

# Be sure to get all the modules we need for our Ikiwiki
apt-get -y --no-install-recommends install \
        libfile-chdir-perl \
        libhtml-scrubber-perl \
        libhtml-template-perl \
        libtext-multimarkdown-perl \
        libtimedate-perl \
        liburi-perl libhtml-parser-perl \
        libxml-simple-perl \
        libyaml-libyaml-perl po4a \
        libyaml-perl \
        libyaml-syck-perl \
        perlmagick \
        wdg-html-validator

# Add build script
install -o root -g root -m 755 /vagrant/provision/assets/build-tails /usr/local/bin

disable_live_build_conf()
{
	local var="$1"

	[ -e /etc/live/build.conf ] || return 0
	sed -e "/^[[:space:]]*$var=/d" -i /etc/live/build.conf
}

# Force live-build to use the mirrors configured in auto/config
for prefix in MIRROR PARENT_MIRROR ; do
	for target in BOOTSTRAP BINARY CHROOT ; do
		for archive in '' BACKPORTS SECURITY UPDATES VOLATILE ; do
			if [ -z "$archive" ] ; then
				archive_suffix=''
			else
				archive_suffix="_${archive}"
			fi
			var="LB_${prefix}_${target}${archive_suffix}"
			disable_live_build_conf "$var"
		done
	done
done

# Clean up
apt-get -y autoremove
apt-get -y clean
perl /usr/lib/apt-cacher-ng/expire-caller.pl || echo "The clean-up of apt-cacher-ng's cache failed: this is not fatal and most likely just means that some disk space could not be reclaimed -- in order to fix that situation you need to manually investigate /var/log/apt-cacher-ng/main_*.html " >&2

# XXX: Remove this once we generate a basebox > 20160226
if grep -q "^AcceptEnv" /etc/ssh/sshd_config; then
    sed -i 's/^AcceptEnv/#AcceptEnv/' /etc/ssh/sshd_config
    systemctl reload ssh.service
fi
