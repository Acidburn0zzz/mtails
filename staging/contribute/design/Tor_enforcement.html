<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Tor enforcement</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css" type="text/css" />


<script src="../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../../index.en.html"><img src="../../lib/home.png"></a></li>







<li><a href="../../contribute.en.html">contribute</a></li>





<li><a href="../design.html">design</a></li>




<li>Tor enforcement</li>

</ul>
</span>
<span class="title">
Tor enforcement
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../../about.en.html">About</a></li>
    <li><a href="../../getting_started.en.html">Getting startedâ€¦</a></li>
    <li><a href="../../doc.en.html">Documentation</a></li>
    <li><a href="../../support.en.html">Help &amp; Support</a></li>
    <li><a href="../../contribute.en.html">Contribute</a></li>
    <li><a href="../../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">
<p>Tails short description states that all outgoing connections to the
Internet must to go through the <a href="https://www.torproject.org/">Tor network</a>.</p>

<p>This is almost true. Let's clarify this a bit.</p>

<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">DNS</a>
	</li>
	<li class="L1"><a href="#index2h1">Network filter</a>
	</li>
</ol>
</div>


<h1><a name="index1h1"></a>DNS</h1>

<p>Tor does not support UDP so we cannot simply redirect DNS queries to
the Tor transparent proxy.</p>

<p>Most DNS leaks are avoided by having the system resolver query
the Tor network using the <code>DNSPort</code> configured in
<code>torrc</code>.</p>

<p>There is a concern that any application could attempt to do its own
DNS resolution without using the system resolver; UDP datagrams are
therefore blocked in order to prevent leaks. Another solution may be
to use the Linux network filter to forward outgoing UDP datagrams to
the local DNS proxy.</p>

<p>Tails also forbids DNS queries to RFC1918 addresses; those might
indeed allow the system to learn the local network's public IP
address.</p>

<p><code>resolv.conf</code> is configured to point to the Tor DNS resolver, and <span class="application">NetworkManager<span> and <code>dhclient</code> are configured
not to manage <code>resolv.conf</code> at all:</p>

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/NetworkManager/conf.d/dns.conf">config/chroot local-includes/etc/NetworkManager/conf.d/dns.conf</a></li>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/dhcp/dhclient-enter-hooks.d/disable_make_resolv_conf">config/chroot local-includes/etc/dhcp/dhclient-enter-hooks.d/disable make resolv conf</a></li>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/resolv.conf">config/chroot local-includes/etc/resolv.conf</a></li>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/tor/torrc">config/chroot local-includes/etc/tor/torrc</a></li>
</ul>


<p>Some applications need to be able to do clearnet DNS resolutions, so
we save the DNS configuration obtained by NetworkManager:</p>

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/NetworkManager/dispatcher.d/00-resolv-over-clearnet">config/chroot local-includes/etc/NetworkManager/dispatcher.d/00-resolv-over-clearnet</a></li>
</ul>


<p>The following is the complete list of the applications allowed to use
the clearnet DNS configuration:</p>

<ul>
<li>the <code>tor</code> process itself, but only if the user requested to
configure Tor's network settings in Tails Greeter; in this case
<code>tor</code> being able to resolve hostnames is convenient (e.g. hostnames
are human-readable, IP addresses not as much) or even necessary
(e.g. for the Meek pluggable transport):

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/NetworkManager/dispatcher.d/10-tor.sh">config/chroot local-includes/etc/NetworkManager/dispatcher.d/10-tor.sh</a></li>
</ul>
</li>
<li>the <code>clearnet</code> user used to run the
<a href="./Unsafe_Browser.html">Unsafe Browser</a>:

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/usr/local/sbin/unsafe-browser">config/chroot local-includes/usr/local/sbin/unsafe-browser</a></li>
</ul>
</li>
</ul>


<h1><a name="index2h1"></a>Network filter</h1>

<p>One serious security issue is that we don't know what software will
attempt to contact the network and whether their proxy settings are
set up to use the Tor SOCKS proxy correctly.
This is solved by blocking all outbound Internet traffic except Tor,
and explicitly configuring all applications to use one of
these.</p>

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/ferm/ferm.conf">config/chroot local-includes/etc/ferm/ferm.conf</a>
(uses <a href="http://ferm.foo-projects.org/">ferm</a> to build an <code>iptables</code>
ruleset)</li>
</ul>


<p>The default case is to block all outbound network traffic; let us now
document all exceptions and some clarifications to this rule.</p>

<h4><a name="index1h4"></a>Tor user</h4>

<p>Tor itself obviously has to connect to the Internet without going
through the Tor network. This is achieved by special-casing
connections originating from the <code>debian-tor</code> Unix user.</p>

<h4><a name="index2h4"></a>Unsafe Browser and the <code>clearnet</code> user</h4>

<p>The <code>clearnet</code> user used to run the
<a href="./Unsafe_Browser.html">Unsafe Browser</a> is granted full network access
(but no loopback access) in order to deal with captive portals.</p>

<h4><a name="index3h4"></a>Local Area Network (LAN)</h4>

<p>Tails short description talks of sending through Tor <em>outgoing
connections to the Internet</em>. Indeed: traffic to the local LAN
(RFC1918 addresses) is wide open as well as the loopback traffic
obviously.</p>

<p>LAN DNS queries are forbidden to protect against some attacks.</p>

<h4><a name="index4h4"></a>Local services whitelist</h4>

<p>The Tails firewall uses a whitelist which only grants access to each
local service to the users that actually need it. This blocks
potential leaks due to misconfigurations or bugs, and deanonymization
attacks by compromised processes. For specifics, see the firewall
configuration where this is well commented:
<a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/ferm/ferm.conf">config/chroot local-includes/etc/ferm/ferm.conf</a></p>

<h4><a name="index5h4"></a>Automapped addresses</h4>

<p><code>AutomapHostsOnResolve</code> is enabled in Tor configuration, and
a firewall rule transparently redirects to the Tor transparent proxy
port the connections targeted at the <code>127.192.0.0/10</code> virtual mapped
address space.</p>

<p>Only the <code>amnesia</code> user is granted access to the Tor transparent proxy
port, so in practice only this user can use this hostname-to-address
mapping facility.</p>

<ul>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/tor/torrc">config/chroot local-includes/etc/tor/torrc</a></li>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/ferm/ferm.conf">config/chroot local-includes/etc/ferm/ferm.conf</a></li>
</ul>


<h4><a name="index6h4"></a>IPv6</h4>

<p>Tor does not support IPv6 yet so IPv6 communication is blocked.</p>

<h4><a name="index7h4"></a>UDP, ICMP and other non-TCP protocols</h4>

<p>Tor only supports TCP. Non-TCP traffic to the Internet, such as UDP
datagrams and ICMP packets, is dropped.</p>

<p>An unfortunate consequence of fully blocking ICMP is that <a href="https://en.wikipedia.org/wiki/Path%20MTU%20Discovery">Path MTU Discovery</a> is broken. We workaround this problem by enabling
<a href="https://www.ietf.org/rfc/rfc4821.txt">Packetization Layer Path MTU Discovery</a>.
For details, see:</p>

<ul>
<li><a href="https://git-tails.immerda.ch/tails/commit/?id=1d1c83d">1d1c83d</a></li>
<li><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/sysctl.d/pmtud.conf">config/chroot local-includes/etc/sysctl.d/pmtud.conf</a></li>
</ul>


<h4><a name="index8h4"></a><code>RELATED</code> packets</h4>

<p>As a general rule, the Tails' firewall does not accept <code>RELATED</code>
packets: accepting them enables quite a lot of code in the kernel that
we don't need, so we prefer reducing the attack surface a bit by
blocking them. See the "[Tails-dev] Reducing attack surface of kernel
and tightening firewall/sysctls" thread for details.</p>

<p>However, <code>RELATED</code> ICMP packets to the loopback interface are let
through, in order to smooth user experience whenever a program's local
network connection is blocked, and the TCP stack generates ICMP
packets (e.g. with <code>TYPE=3 CODE=3</code>, i.e. the destination port is
unreachable) to let the program know what is going on early, instead
of letting it wait for a timeout.</p>

<h4><a name="index9h4"></a>netfilter's connection tracking helpers</h4>

<p>We disable netfilter's automatic conntrack helper assignment
(<code>nf_conntrack_helper</code>), that would otherwise enable a lot of code in
the Linux kernel that
<a href="https://home.regit.org/netfilter-en/secure-use-of-helpers/">parses incoming network packets, which seems potentially unsafe</a>
compared to the little gain it brings in the use case of Tails:</p>

<p><a href="https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/etc/modprobe.d/no-conntrack-helper.conf">config/chroot local-includes/etc/modprobe.d/no-conntrack-helper.conf</a></p>

</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="../../about.en.html">about</a>

<a href="../../about.ar.html">about.ar</a>

<a href="../../about.ca.html">about.ca</a>

<a href="../../about.de.html">about.de</a>

<a href="../../about.es.html">about.es</a>

<a href="../../about.fa.html">about.fa</a>

<a href="../../about.fr.html">about.fr</a>

<a href="../../about.it.html">about.it</a>

<a href="../../about.pl.html">about.pl</a>

<a href="../../about.pt.html">about.pt</a>


<span class="popup">...
<span class="balloon">

<a href="../../about.ru.html">about.ru</a>

<a href="../../about.sr_Latn.html">about.sr Latn</a>

<a href="../../about.tr.html">about.tr</a>

<a href="../../about.zh.html">about.zh</a>

<a href="../../about.zh_TW.html">about.zh TW</a>

</span>
</span>

</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/design/Tor_enforcement">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
