<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - What must I do now that the Git repository&#x27;s history has been rewritten?</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css" type="text/css" />


<script src="../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../../index.en.html"><img src="../../lib/home.png"></a></li>







<li><a href="../../contribute.en.html">contribute</a></li>





<li><a href="../git.html">git</a></li>




<li>What must I do now that the Git repository&#x27;s history has been rewritten?</li>

</ul>
</span>
<span class="title">
What must I do now that the Git repository&#x27;s history has been rewritten?
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../../about.en.html">About</a></li>
    <li><a href="../../getting_started.en.html">Getting startedâ€¦</a></li>
    <li><a href="../../doc.en.html">Documentation</a></li>
    <li><a href="../../support.en.html">Help &amp; Support</a></li>
    <li><a href="../../contribute.en.html">Contribute</a></li>
    <li><a href="../../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">


<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Back up your local Git directory</a>
	</li>
	<li class="L1"><a href="#index2h1">Store the name of the official Git remote</a>
	</li>
	<li class="L1"><a href="#index3h1">Delete all local tags</a>
	</li>
	<li class="L1"><a href="#index4h1">Fetch the rewritten history</a>
	</li>
	<li class="L1"><a href="#index5h1">Back up your existing local branches</a>
	</li>
	<li class="L1"><a href="#index6h1">Clean up your personal Git repository</a>
	</li>
	<li class="L1"><a href="#index7h1">Start working again</a>
	</li>
</ol>
</div>




<div class="note">

This is about the main Tails Git repository. Other repositories, such
as the ones for the Greeter and other custom software, are not affected.

</div>


<h1><a name="index1h1"></a>Back up your local Git directory</h1>

<div class="caution">

If you make a mistake, some of the operations below will destroy your
great carefully hand-crafted Tails work.

</div>


<p>Therefore, first backup the directory where your local Git working
directory lives.</p>

<h1><a name="index2h1"></a>Store the name of the official Git remote</h1>

<p>Find out how you have named the Git remote that points to the official
repository:</p>

<pre><code>OFFICIAL_REMOTE=$(git remote -v \
   | grep --color=never -E \
      '[a-zA-Z0-9_-]+\s+(https://git-tails.immerda.ch/tails(?:.git)?\s+|(ssh://)?boum_org_amnesia@webmasters\.boum\.org(:wiki\.git|/~/wiki.git)).*\(fetch\)$' \
   | awk '{print $1}')
[ -n "$OFFICIAL_REMOTE" ] || echo "No official remote found."
</code></pre>

<p>If you see "No official remote found", then you are probably using
a deprecated or unsafe URL for your official remote. You'll need to
fix that first: <a href="../git.html#main-repo">find out what the correct URL
is</a>, and then fix it in <code>.git/config</code> and
run the commands above again.</p>

<div class="caution">

All commands that follow must be run in the same terminal as the
previous ones: they are going to reuse the
<code>$OFFICIAL_REMOTE</code> shell variable and may do pretty ugly
things if it is not properly defined.

</div>


<h1><a name="index3h1"></a>Delete all local tags</h1>

<p>So that you don't publish again any deleted tag that was based on the old,
non-rewritten history, delete all local tags you have:</p>

<pre><code>git tag | xargs git tag -d
</code></pre>

<h1><a name="index4h1"></a>Fetch the rewritten history</h1>

<p>Fetch the content of the updated official repository:</p>

<pre><code>git fetch --prune "$OFFICIAL_REMOTE" &amp;&amp; \
   git fetch "$OFFICIAL_REMOTE" --tags
</code></pre>

<h1><a name="index5h1"></a>Back up your existing local branches</h1>

<p>Rename every local branch so that their name starts with the
<code>old-</code> prefix:</p>

<pre><code>for b in $(git branch --no-color) ; do
   [ "$b" != '*' ] || continue
   git branch -m "$b" "old-$b"
done
</code></pre>

<p>This is needed for two reasons:</p>

<ul>
<li><p>This makes sure that any work you may have started in the past, and
that was not merged yet, is saved somewhere and can be salvaged
later if needed.</p></li>
<li><p>The <code>old-</code> prefix is meant to be a warning sign, so that you don't
mistakenly base future work on the old, non-rewritten Git history
(such work <em>cannot</em> be merged into the official repository anymore,
as it would re-import all the data we just managed to get rid of).</p></li>
</ul>


<h1><a name="index6h1"></a>Clean up your personal Git repository</h1>

<p>If you have a personal online Git repository, please consider
following these instructions.</p>

<p>It is not compulsory, but if you don't do that, then any new
contributor who adds your personal Git repository as a Git remote will
need to download hundreds of megabytes of useless data, which is not
very welcoming. In particular, newcomers on your team would be
negatively affected... and you want new teammates, right? :)
I'm looking at you, dear translators.</p>

<p>So, right now your personal Git repository contains <em>both</em> the old
(non-rewritten) and the new (rewritten) Git history. Here is how to
get rid of the old one.</p>

<h3><a name="index1h3"></a>Set the <code>MY_REMOTE</code> variable</h3>

<p>In the following command, replace <code>XXX_REPLACE_ME</code> with the name of the remote
that points to your personal online Git repository:</p>

<pre><code>MY_REMOTE=XXX_REPLACE_ME
</code></pre>

<h2><a name="index1h2"></a>Delete all remote branches</h2>

<p>List branches that are in your personal online Git repository (in the
following commands, ):</p>

<pre><code>git branch --no-color -r --list "${MY_REMOTE}/*" \
   | grep -vE "^\s+${MY_REMOTE}/HEAD\s+"
</code></pre>

<p>For each such branch, check if you have work in there that can still
be useful. If it's the case, then export it outside of Git, e.g.
using <code>git format-patch</code>.</p>

<p>Then, delete all remote branches in your personal online Git
repository:</p>

<pre><code>for remote_branch in $(git branch --no-color -r --list "${MY_REMOTE}/*" \
           | grep -vE "^\s+${MY_REMOTE}/HEAD\s+") ; do
   branch=$(echo "$remote_branch" | sed -r -e "s,^${MY_REMOTE}/,,")
   git push --force "$MY_REMOTE" ":$branch"
done
</code></pre>

<h2><a name="index2h2"></a>Make sure you publish only up-to-date tags</h2>

<p>Force-push the updated tags so that they replace the old ones in your
personal online Git repository:</p>

<pre><code>git push --force "$MY_REMOTE" --tags
</code></pre>

<h1><a name="index7h1"></a>Start working again</h1>

<p>You may use <code>git checkout</code> as usual to create:</p>

<ul>
<li>a new local branch, for work you are starting right now;</li>
<li>a new local branch tracking one that exists in the official
repository already, for work you are following-up on.</li>
</ul>


<p>Later, when you push a branch to your personal Git repository:</p>

<ul>
<li>The first time you do that, it can take a while.</li>
<li>If that branch did previously exist there, then you may need to pass
the <code>--force</code> option to <code>git push</code>: to avoid losing data, Git
refuses to rewrite history on the remote by default, so in the rare
cases when we want to do that (which is precisely the case here),
one has to override this protection.</li>
</ul>


</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">












</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/git/post-rewrite">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
