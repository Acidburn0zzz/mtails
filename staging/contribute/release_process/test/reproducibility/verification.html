<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Verification of Tails reproducibility</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../../../style.css" type="text/css" />

<link rel="stylesheet" href="../../../../local.css" type="text/css" />


<script src="../../../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../../../../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../../../../index.en.html"><img src="../../../../lib/home.png"></a></li>







<li><a href="../../../../contribute.en.html">contribute</a></li>





<li><a href="../../../release_process.html">release process</a></li>





<li><a href="../../test.html">test</a></li>





<li><a href="../../../../index.en.html">reproducibility</a></li>




<li>Verification of Tails reproducibility</li>

</ul>
</span>
<span class="title">
Verification of Tails reproducibility
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../../../../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../../../../about.en.html">About</a></li>
    <li><a href="../../../../getting_started.en.html">Getting startedâ€¦</a></li>
    <li><a href="../../../../doc.en.html">Documentation</a></li>
    <li><a href="../../../../support.en.html">Help &amp; Support</a></li>
    <li><a href="../../../../contribute.en.html">Contribute</a></li>
    <li><a href="../../../../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">


<div class="note">

After accepting to be the Trusted Verifier you should have been
instructed to go here immediately and read the "Preparation"
section. For a planned release you should be doing this weeks before
the release you are about to reproduce; for emergency releases you
likely only have days or even hours. If you were not, please file a
ticket about this, since an important part of process must have been
missed by the RM.

</div>




<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Preparation (when accepting to be the Trusted Verifier)</a>
	</li>
	<li class="L1"><a href="#index2h1">Inputs</a>
	<ol>
		<li class="L2"><a href="#index1h2">Inputs from the release process</a>
		</li>
		<li class="L2"><a href="#index2h2">Inputs from the testing pad</a>
		</li>
		<li class="L2"><a href="#index3h2">Your inputs</a>
		</li>
		<li class="L2"><a href="#index4h2">Derived environment variables</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index3h1">Download published products</a>
	</li>
	<li class="L1"><a href="#index4h1">Obtain needed old Tails releases</a>
	</li>
	<li class="L1"><a href="#index5h1">Refresh iuk and perl5lib Git repos</a>
	</li>
	<li class="L1"><a href="#index6h1">Reproduce Tails</a>
	<ol>
		<li class="L2"><a href="#index5h2">Fetch and verify the Git tag</a>
		</li>
		<li class="L2"><a href="#index6h2">Reproduce the image</a>
		</li>
		<li class="L2"><a href="#index7h2">Reproduce IUKs</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index7h1">Verification</a>
	<ol>
		<li class="L2"><a href="#index8h2">Verify your products</a>
		</li>
		<li class="L2"><a href="#index9h2">Verify published products</a>
		</li>
		<li class="L2"><a href="#index10h2">Verify IDF</a>
		</li>
		<li class="L2"><a href="#index11h2">Verify UDFs</a>
		</li>
	</ol>
	</li>
</ol>
</div>


<p><a id="preparation"></a></p>

<h1><a name="index1h1"></a>Preparation (when accepting to be the Trusted Verifier)</h1>

<p>Use whatever scheduling tool you prefer to make sure you will, on your
own initiative, return to this document and follow it within 72 hours
from the start of the manual testing session. In particular, do not
trust anything said by the RM about this process.</p>

<h1><a name="index2h1"></a>Inputs</h1>

<h2><a name="index1h2"></a>Inputs from the release process</h2>

<p>Look at the "Environment" section at the beginning of <a href="../../../release_process.html">the release
process instructions</a> and set the
following variables as instructed:</p>

<ul>
<li><code>ARTIFACTS</code></li>
<li><code>DIST</code></li>
<li><code>ISOS</code></li>
<li><code>IUK_CHECKOUT</code></li>
<li><code>PERL5LIB_CHECKOUT</code></li>
<li><code>RELEASE_BRANCH</code></li>
<li><code>VERSION</code></li>
</ul>


<p>Now for the only tricky part, setting <code>IUK_SOURCE_VERSIONS</code>. It should
simply list the old Tails versions that will get an automatic upgrade
to the current release, and should be set correctly by this command
most of the time:</p>

<pre><code>IUK_SOURCE_VERSIONS="$(
    curl "http://dl.amnesia.boum.org/tails/${DIST:?}/iuk/" \
    | grep --extended-regexp --only-matching \
           "Tails_amd64_[^_]+_to_${VERSION:?}.iuk" \
    | sort -u \
    | tr '_' ' ' \
    | cut -d' ' -f3
)"
echo -e "Got these IUK source versions:\n${IUK_SOURCE_VERSIONS}"
</code></pre>

<p>Now sanity check the contents of <code>IUK_SOURCE_VERSIONS</code>:</p>

<ul>
<li>If empty, the RM has probably not uploaded them yet so you may have
to wait.</li>
<li>make sure each listed version actually has been released! :)</li>
<li><a href="../../../release_process.html#prepare-iuk">Figure out the rules for how to set this
variable</a> and double-check
that it makes sense! Note that exceptions happen (e.g. there could
be a bug in some old versions upgrader so we skip it).</li>
<li>If the release notes have already been written (generally there is a
ticket about it) it should list which versions</li>
</ul>


<h2><a name="index2h2"></a>Inputs from the testing pad</h2>

<p>In the "Reproducibility" section of the testing pad you'll find
clear-signed hashes for all products of this release. Verify the
signature, and put the hashes (excluding the OpenPGP signature data)
into a file called <code>SHA512SUMS.txt</code>.</p>

<h2><a name="index3h2"></a>Your inputs</h2>

<p>Set these environment variables accordingly:</p>

<ul>
<li><code>ISOS_CHECKOUT</code>: path to your Tails ISO history repo checout.</li>
<li><code>PACKAGES_FILE</code>: path to the <code>.packages</code> file for this release
(should be attached to the "Testing Tails <code>$VERSION</code>" email you have
in your inbox)</li>
<li><code>PUBLISHED_ARTIFACTS</code>: some <em>new</em> directory where you can download
gigabytes of data to.</li>
<li><code>SHA512SUMS</code>: the path of the <code>SHA512SUMS.txt</code> file from above.</li>
<li><code>TAILS_CHECKOUT</code>: path to your Tails Git repo checkout.</li>
</ul>


<h2><a name="index4h2"></a>Derived environment variables</h2>

<pre><code>cd "${TAILS_CHECKOUT:?}" &amp;&amp; \
TAG="$(echo $VERSION | tr '~' '-')" &amp;&amp; \
TAG_COMMIT="$(git rev-parse --verify ${TAG:?})" &amp;&amp; \
git fetch &amp;&amp; \
git checkout "${RELEASE_BRANCH:?}" &amp;&amp; \
git merge "origin/${RELEASE_BRANCH:?}" &amp;&amp; \
PERL5LIB_VERSION="$(awk '/^tails-perl5lib\s/ { print $2 }' "${PACKAGES_FILE:?}")" &amp;&amp; \
if [ -z "${PERL5LIB_VERSION}" ]; then
    echo 'Failed to determine PERL5LIB_VERSION, aborting' &amp;&amp; \
    false
fi &amp;&amp; \
PERL5LIB_CHECKOUT_TAG="debian/${PERL5LIB_VERSION}" &amp;&amp; \
IUK_VERSION="$(awk '/^tails-iuk\s/ { print $2 }' "${PACKAGES_FILE:?}")" &amp;&amp; \
if [ -z "${IUK_VERSION}" ]; then
    echo 'Failed to determine IUK_VERSION, aborting' &amp;&amp; \
    false
fi &amp;&amp; \
IUK_CHECKOUT_TAG="debian/${IUK_VERSION}"
</code></pre>

<h1><a name="index3h1"></a>Download published products</h1>

<pre><code>mkdir -p "${PUBLISHED_ARTIFACTS:?}" &amp;&amp; \
cd "${PUBLISHED_ARTIFACTS:?}" &amp;&amp; \
mkdir tails-amd64-${VERSION:?} &amp;&amp; \
cd tails-amd64-${VERSION:?} &amp;&amp; \
wget http://dl.amnesia.boum.org/tails/${DIST:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso &amp;&amp; \
cd .. &amp;&amp; \
for old_version in ${IUK_SOURCE_VERSIONS}; do
    wget http://dl.amnesia.boum.org/tails/${DIST:?}/iuk/Tails_amd64_${old_version}_to_${VERSION:?}.iuk
done
</code></pre>

<h1><a name="index4h1"></a>Obtain needed old Tails releases</h1>

<pre><code>cd "${ISOS_CHECKOUT:?}" &amp;&amp; \
git annex sync &amp;&amp; \
for old_version in ${IUK_SOURCE_VERSIONS:?}; do
    tails_dir="tails-amd64-${old_version}" &amp;&amp; \
    if [ ! -d "${ISOS:?}/${tails_dir}" ];  then
        git annex get "${tails_dir}" &amp;&amp; \
        cp --dereference --recursive "${tails_dir}" "${ISOS:?}"
    fi
done
</code></pre>

<h1><a name="index5h1"></a>Refresh iuk and perl5lib Git repos</h1>

<pre><code>cd "${PERL5LIB_CHECKOUT:?}" &amp;&amp; \
git fetch &amp;&amp; \
git checkout "${PERL5LIB_CHECKOUT_TAG:?}" &amp;&amp; \
cd "${IUK_CHECKOUT:?}" &amp;&amp; \
git fetch &amp;&amp; \
git checkout "${IUK_CHECKOUT_TAG:?}"
</code></pre>

<h1><a name="index6h1"></a>Reproduce Tails</h1>

<h2><a name="index5h2"></a>Fetch and verify the Git tag</h2>

<pre><code>cd "${TAILS_CHECKOUT:?}" &amp;&amp; \
git fetch origin "${TAG}" &amp;&amp; \
git tag -v "${TAG}"
</code></pre>

<ul>
<li><p>If the last output is a "Good signature" for the expected tag, made by
Tails signing key, then we are good.</p></li>
<li><p>Otherwise, if you see <em>anything</em> else, we're <em>not</em> good; immediately
contact the RM and tails@! Proceeding with the rest of the steps
are pointless in this case, so await instruction.</p></li>
</ul>


<h2><a name="index6h2"></a>Reproduce the image</h2>

<pre><code>cd "${TAILS_CHECKOUT:?}" &amp;&amp; \
git checkout "${TAG:?}" &amp;&amp; \
git submodule update --init &amp;&amp; \
export SOURCE_DATE_EPOCH=$(date --utc --date="$(dpkg-parsechangelog --show-field=Date)" '+%s') &amp;&amp; \
rake build &amp;&amp; \
mkdir "${ISOS:?}/tails-amd64-${VERSION:?}" &amp;&amp; \
mv "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.iso" \
   "${ISOS:?}/tails-amd64-${VERSION:?}/"
</code></pre>

<h2><a name="index7h2"></a>Reproduce IUKs</h2>

<p>Follow the <a href="../../../release_process.html#prepare-iuk">Build the Incremental Upgrade
Kits</a> instructions. Note that
the value of <code>SOURCE_DATE_EPOCH</code> set above is needed!</p>

<h1><a name="index7h1"></a>Verification</h1>

<p>If there is <em>any</em> type of mismatch at some point below, let the RM and
tails@ know <em>immediately</em>! But still proceed and do everything below,
potentially reporting multiple different issues.</p>

<h2><a name="index8h2"></a>Verify your products</h2>

<pre><code>cd "${ISOS:?}" &amp;&amp; \
sha512sum -c "${SHA512SUMS:?}"
</code></pre>

<h2><a name="index9h2"></a>Verify published products</h2>

<pre><code>cd "${PUBLISHED_ARTIFACTS:?}" &amp;&amp; \
sha512sum -c "${SHA512SUMS:?}"
</code></pre>

<h2><a name="index10h2"></a>Verify IDF</h2>

<p>This step can only be done after the release is been made public.</p>

<p>Examine the IDF by running:</p>

<pre><code>curl https://tails.boum.org/install/v1/Tails/amd64/${DIST:?}/latest.yml
</code></pre>

<p>and checking that it matches the output of the following command:</p>

<pre><code>cat &lt;&lt;-EOF
sha256: $(sha256sum "${ISOS:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso" | cut -f 1 -d ' ' | tr -d '\n')
size: $(du --bytes "${ISOS:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso" | cut -f1)
url: http://dl.amnesia.boum.org/tails/${DIST:?}/tails-amd64-$VERSION/tails-amd64-$VERSION.iso
EOF
</code></pre>

<p>Keep this output, you will need it below!</p>

<h2><a name="index11h2"></a>Verify UDFs</h2>

<p>This step can only be done after the release is been made public.</p>

<p>Examine each UDF by running:</p>

<pre><code>for old_version in ${IUK_SOURCE_VERSIONS}; do
    url=https://tails.boum.org/upgrade/v1/Tails/${old_version}/amd64/${DIST:?}/upgrades.yml
    (
        echo "Looking at '${url}':"
        echo
        curl --silent --show-error ${url}
    ) | less
done
</code></pre>

<p>and checking that there are either one or two <code>target-files</code>
entries:</p>

<ul>
<li><p><code>type: full</code> means a full upgrade (so it refers to the ISO image)
and must have the same values as for the IDF (you were asked to save
the output above), so please verify that it matches!</p></li>
<li><p><code>type: incremental</code> means an incremental upgrade (so it refers to a
IUK) and should match the output of:</p>

<pre><code>for old_version in ${IUK_SOURCE_VERSIONS}; do
cat &lt;&lt;EOF
Expected values for https://tails.boum.org/upgrade/v1/Tails/${old_version}/amd64/${DIST:?}/upgrades.yml:

sha256: $(sha256sum "${ISOS:?}/Tails_amd64_${old_version}_to_${VERSION:?}.iuk" | cut -f 1 -d ' ' | tr -d '\n')
size: $(du --bytes "${ISOS:?}/Tails_amd64_${old_version}_to_${VERSION:?}.iuk" | cut -f1)
url: http://dl.amnesia.boum.org/tails/${DIST:?}/iuk/Tails_amd64_${old_version}_to_${VERSION:?}.iuk

EOF
done
</code></pre></li>
</ul>


</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="../../../../news/report_2018_02.html">news/report 2018 02</a>


</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/release_process/test/reproducibility/verification">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
