<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Releasing tails-installer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css" type="text/css" />


<script src="../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../../index.en.html"><img src="../../lib/home.png"></a></li>







<li><a href="../../contribute.en.html">contribute</a></li>





<li><a href="../release_process.html">release process</a></li>




<li>Releasing tails-installer</li>

</ul>
</span>
<span class="title">
Releasing tails-installer
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../../about.en.html">About</a></li>
    <li><a href="../../getting_started.en.html">Getting startedâ€¦</a></li>
    <li><a href="../../doc.en.html">Documentation</a></li>
    <li><a href="../../support.en.html">Help &amp; Support</a></li>
    <li><a href="../../contribute.en.html">Contribute</a></li>
    <li><a href="../../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">


<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">The big picture</a>
	<ol>
		<li class="L2"><a href="#index1h2">Upstream</a>
		</li>
		<li class="L2"><a href="#index2h2">Packaging</a>
		</li>
		<li class="L2"><a href="#index3h2">Topic branches</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index2h1">Workflow</a>
	<ol>
		<li class="L2"><a href="#index4h2">Release a new upstream version</a>
		<ol>
			<li class="L3"><a href="#index1h3">Prepare the environment</a>
			</li>
			<li class="L3"><a href="#index2h3">Tag the new version</a>
			</li>
			<li class="L3"><a href="#index3h3">Generate a new upstream tarball</a>
			</li>
		</ol>
		</li>
		<li class="L2"><a href="#index5h2">Update the Debian package for Tails</a>
		</li>
		<li class="L2"><a href="#index6h2">If you are a member of the Debian pkg-privacy team</a>
		</li>
		<li class="L2"><a href="#index7h2">Add the Debian package to Tails</a>
		</li>
		<li class="L2"><a href="#index8h2">Update the Debian package</a>
		</li>
		<li class="L2"><a href="#index9h2">Upload a package to our Ubuntu PPA</a>
		</li>
		<li class="L2"><a href="#index10h2">Quality assurance for Debian and Ubuntu packages</a>
		</li>
	</ol>
	</li>
</ol>
</div>


<h1><a name="index1h1"></a>The big picture</h1>

<h2><a name="index1h2"></a>Upstream</h2>

<p>For this package, "upstream" means, from a Debian packaging
point-of-view, the state of our upstream branches. Let's not pretend we
have not forked liveusb-creator, and admit we are now upstream for our
own version. Thus, from version 4.x on, our fork has been renamed to
tails-installer.</p>

<p>The <code>master</code> branch must always be the one that targets current Tails
and possibly <em>also</em> earlier Debian releases. At the moment it supports
Debian Stretch, Buster and Sid.</p>

<p>But that's not enough, since we also need to put releases out with code
that works on current Debian testing/unstable. Thus, we maintain several upstream
release branches in parallel, each with their own major version number:</p>

<ul>
<li>for work and releases that target Stretch (and, as long
as compatible, that target Debian testing/unstable as well):

<ul>
<li>branch = <code>master</code></li>
<li>version = <code>5.*</code></li>
<li>tag = <code>tails-installer_5.*</code></li>
</ul>
</li>
</ul>


<p>Once we can't support both Stretch and Debian testing/unstable
with the same codebase anymore, we'll fork a new upstream release
branch that targets Debian testing, it'll be called
<code>feature/$codename</code>, use version <code>6.*</code>, etc.</p>

<h2><a name="index2h2"></a>Packaging</h2>

<p>We're using <a href="http://dep.debian.net/deps/dep14/">DEP-14 conventions</a>,
except for our <code>master</code> branch which is used for upstream development
targeted at current Tails, as said above. More specifically:</p>

<ul>
<li>The <code>pristine-tar</code> branch contains the binary delta between DFSG-freed
tarballs and the corresponding tag. It's automatically maintained by
<code>gbp import-orig</code>.</li>
<li>The <code>debian/sid</code> branch is used to build the package that we upload to
Debian unstable. The tags on this branch are called <code>debian/$package_version</code>,
which is the default when creating them with
<code>gbp buildpackage --git-sign-tags --git-tag-only</code>;
in practice this is something like <code>debian/5.3+dfsg-1</code>.</li>
<li>The <code>debian/$codename-backports</code> branch is used to prepare packages
that we upload to the official backports repository for Debian <code>$codename</code>.
E.g. here we want to have <code>debian/stretch-backports</code> soon after the initially
uploaded package reaches Debian testing. The tags on this branch are
also called <code>debian/$package_version</code>. In practice this is something
like <code>debian/5.3+dfsg-1~bpo8+1</code>.</li>
<li>The <code>tails/master</code> branch is used to prepare packages that we upload
to the Tails APT repo for Tails stable releases, but not to Debian.</li>
<li>The <code>tails/$codename</code> branch is used to prepare packages that we upload
to the Tails APT repo but for (non-stable) Tails based on Debian
<code>$codename</code>. Again, these packages will not be uploaded to Debian.</li>
<li>Additionally, we use <code>tails/$feature</code> branches for other
Tails-specific packaging branches.</li>
<li>The <code>upstream/4.x+dfsg</code>, <code>upstream/5.x+dfsg</code>, etc. branches are what
we tell <code>gbp</code> to use as its "upstream" branch. Make sure to check
them out when setting up the repository for the first time.</li>
<li>For Ubuntu, we want to support the current Ubuntu version, the
upcoming version, and the current LTS: <a href="https://en.wikipedia.org/wiki/Ubuntu%20version%20history">Ubuntu version history</a>.
We do not maintain any Git branches related to Ubuntu releases, as
simply the changelog entries are modified.</li>
</ul>


<h2><a name="index3h2"></a>Topic branches</h2>

<p>In practice, it's expected that Tails contributors submit bugfix and
feature branches forked off <code>master</code>, because they want them part of next
Tails release. Hence, it will happen that code lands into <code>master</code> first,
and in turn into a new <code>5.*</code> upstream release, before it lands into e.g.
<code>feature/buster</code> and in turn into a new <code>6.*</code> upstream release.</p>

<p>For how to package topic branches (<code>bugfix/*</code> and <code>feature/*</code>), see
<a href="./tails-installer/topic_branch.html">the dedicated page</a>.</p>

<h1><a name="index2h1"></a>Workflow</h1>

<h2><a name="index4h2"></a>Release a new upstream version</h2>

<p><a id="upstream-prepare"></a></p>

<h3><a name="index1h3"></a>Prepare the environment</h3>

<p>The new upstream version should be something like <code>5.3</code>, based on the
upstream branch you are building the Debian package for. Adjust and
export:</p>

<pre><code>export NEW_UPSTREAM_VERSION=5.replace_me
export UPSTREAM_DEV_BRANCH=master
export PKG_NAME=tails-installer
</code></pre>

<p><a id="upstream-tag"></a></p>

<h3><a name="index2h3"></a>Tag the new version</h3>

<pre><code>git checkout "$UPSTREAM_DEV_BRANCH" &amp;&amp; \
./setup.py build &amp;&amp; \
   (cd po &amp;&amp; \
       for po in *.po ; do msgmerge --update "$po" \
       "$PKG_NAME.pot" ; done \
   ) &amp;&amp; \
   git commit po -m 'Update POT and PO files.' &amp;&amp; \
git tag \
   -s "${PKG_NAME}_${NEW_UPSTREAM_VERSION}" \
   -m "Releasing Tails Installer $NEW_UPSTREAM_VERSION" &amp;&amp; \
git push --tags origin "$UPSTREAM_DEV_BRANCH"
</code></pre>

<p><a id="upstream-tarball"></a></p>

<h3><a name="index3h3"></a>Generate a new upstream tarball</h3>

<pre><code>mkdir -p ../tarballs &amp;&amp; \
git archive \
   --prefix="${PKG_NAME}-${NEW_UPSTREAM_VERSION}/" \
   --output="../tarballs/${PKG_NAME}_${NEW_UPSTREAM_VERSION}.tar.gz" \
   "$UPSTREAM_DEV_BRANCH"
</code></pre>

<p><a id="tails-package"></a></p>

<h2><a name="index5h2"></a>Update the Debian package for Tails</h2>

<p>Checkout the packaging branch, e.g.:</p>

<pre><code>export PKG_NAME=tails-installer
export PACKAGING_BRANCH=tails/master
git checkout "$PACKAGING_BRANCH"
</code></pre>

<p>Here we assumed that <code>tails/master</code> still supports Debian Sid,
otherwise <code>PACKAGING_BRANCH</code> should be <code>tails/${codename}</code>.</p>

<p>Merge Debian packaging changes:</p>

<pre><code>git fetch debian &amp;&amp; \
codename="${PACKAGING_BRANCH/*\//}" &amp;&amp; \
if [ "${codename}" = "master" ]; then
    codename=sid
fi &amp;&amp; \
git merge "debian/debian/${codename}"
</code></pre>

<p>Verify that <code>debian/gbp.conf</code> references the correct upstream and Debian (packaging) branches,
and that <code>pristine-tar</code> usage is enabled, e.g.:</p>

<pre><code>[DEFAULT]
upstream-branch = upstream/5.x+dfsg
debian-branch = tails/${codename}
debian-tag = tails/%(version)s
pristine-tar = True
</code></pre>

<p>Extract the upstream and packaging branch from gbp.conf:</p>

<pre><code>export UPSTREAM_BRANCH=$(gbp config buildpackage.upstream-branch \
                         | sed -r -e 's,.*=,,')
</code></pre>

<p>Create a DFSG-compatible tarball from the previously created Git
archive and reimport it into the source tree. This merges, into the
<code>debian-branch</code> specified in <code>gbp.conf</code>, not only the commit that
imported the current DFSG-free upstream tarball into the
<code>upstream-branch</code>, but also the corresponding upstream Git history:</p>

<pre><code>mk-origtargz \
   -C ../tarballs \
   --version "$NEW_UPSTREAM_VERSION+dfsg" \
   --copy \
   ../tarballs/${PKG_NAME}_${NEW_UPSTREAM_VERSION}.tar.gz &amp;&amp; \
gbp import-orig \
   --upstream-vcs-tag="${PKG_NAME}_$NEW_UPSTREAM_VERSION" \
   ../tarballs/${PKG_NAME}_${NEW_UPSTREAM_VERSION}+dfsg.orig.tar.gz
</code></pre>

<p>Update <code>debian/changelog</code>:</p>

<pre><code>gbp dch &amp;&amp; dch -e
</code></pre>

<p>The raw data compiled by <code>gbp dch</code> must be edited to convey
information that's relevant and self-contained for a Debian audience
(clearly our upstream commit messages are not written with this
audience in mind). For example, the 5.0.4+dfsg-0tails1 changelog entry
is pretty good, but things like "Apply awful hack to fix Tails#14755"
are meaningless for a Debian audience.</p>

<p>Also:</p>

<ul>
<li>Set the appropriate version number, such as <code>5.3+dfsg-0tails1</code>; in
particular, note that the Debian revision starts with <code>-0</code> for any
package meant for the Tails APT repository, while the first package
that will be uploaded to Debian will have <code>-1</code>;</li>
<li>Set the appropriate target release name.</li>
<li>Make sure every Tails ticket ID is of the form <code>Tails#NNNNN</code>, not
<code>#NNNNN</code> and definitely not <code>Closes: #NNNNN</code>.</li>
</ul>


<p>Commit the changelog:</p>

<pre><code>git commit debian/changelog \
    -m "$(dpkg-parsechangelog -SSource) ($(dpkg-parsechangelog -SVersion))

Git-Dch: Ignore
"
</code></pre>

<p>Make sure that the working environment is clean:</p>

<pre><code>git clean -fdx
</code></pre>

<p>Build a new Tails package (use a amd64 chroot that matches the target distribution):</p>

<pre><code>gbp buildpackage
</code></pre>

<p>Add a signed tag to the Git repository and push the changes:</p>

<pre><code>gbp buildpackage --git-tag-only --git-sign-tags &amp;&amp; \
git push --tags origin "$UPSTREAM_BRANCH" \
                "$PACKAGING_BRANCH" \
                pristine-tar
</code></pre>

<h2><a name="index6h2"></a>If you are a member of the Debian pkg-privacy team</h2>

<p>Add the remote:</p>

<pre><code>git remote add debian git@salsa.debian.org:pkg-privacy-team/tails-installer.git
</code></pre>

<p>Then push:</p>

<pre><code>git push --tags debian "$UPSTREAM_BRANCH" \
                "$PACKAGING_BRANCH" \
                pristine-tar
</code></pre>

<p>Never force push! If <code>git push</code> fails you may have to merge back in
e.g. <code>debian/pristine-tar</code> into your local <code>pristine-tar</code> and push
again. Also push it to <code>origin</code>, in that case.</p>

<h2><a name="index7h2"></a>Add the Debian package to Tails</h2>

<p>Sign the package:</p>

<pre><code>debsign $CHANGES_FILE
</code></pre>

<p>Upload:</p>

<pre><code>dupload --to tails $CHANGES_FILE
</code></pre>

<h2><a name="index8h2"></a>Update the Debian package</h2>

<p>This assumes that the latest upstream release has been imported into
the <code>tails/master</code> branch already.</p>

<p>And then, a maintainer of <code>tails-installer</code> in Debian updates the
package in sid accordingly, for example:</p>

<ul>
<li>check out the <code>debian/sid</code> branch</li>
<li>merge the <code>tails/master</code> branch</li>
<li>bump version to <code>5.3+dfsg-1</code></li>
<li>build, test and upload to sid</li>
<li>have gbp create a <code>debian/5.3+dfsg-1</code> tag</li>
<li>push the Debian packaging branch (<code>debian/sid</code>) and the new tag</li>
</ul>


<p>Example for a backport to Stretch:</p>

<ul>
<li>check out the <code>debian/stretch-backports</code> branch</li>
<li>merge the <code>debian/sid</code> branch</li>
<li><code>dch --bpo</code> to bump version to <code>5.3+dfsg-1~bpo9+1</code></li>
<li>build, test and upload to stretch-backports</li>
<li>have gbp create a <code>debian/5.3+dfsg-1_bpo9+1</code> tag</li>
<li>push the Debian packaging branch (<code>debian/stretch-backports</code>) and the new tag</li>
</ul>


<h2><a name="index9h2"></a>Upload a package to our Ubuntu PPA</h2>

<p>Team members are allowed to upload a package to our Ubuntu PPA:
<a href="https://launchpad.net/~tails-team/+archive/ubuntu/tails-installer">https://launchpad.net/~tails-team/+archive/ubuntu/tails-installer</a></p>

<p>You'll need to configure the dput tool to upload to the PPA and put into
<code>$HOME/.dput.cf</code> (adjust to use your Launchpad ID):</p>

<pre><code>[ppa-tails-installer]
fqdn = ppa.launchpad.net
method = ftp
incoming = ~tails-team/ubuntu/tails-installer/
login = your_launchpad_id
allow_unsigned_uploads = 0
</code></pre>

<ul>
<li>checkout the <code>debian/sid</code> branch
to build a package for the next Ubuntu release or checkout the
<code>debian/stretch-backports</code> branch to build a package for the
current Ubuntu version or current LTS.</li>
<li>bump version to <code>5.3+dfsg-0ubuntu1~$codename</code> using <code>dch -i</code>
where <code>$codename</code> is the name of the target Ubuntu distribution.</li>
<li>if it does not exist, rebuild the .orig.tar.gz of the latest version
from pristine-tar (use the latest git log entry to find the version):
<code>pristine-tar checkout ../tails-installer_5.3+dfsg.orig.tar.gz</code></li>
<li>build a source only package using <code>debuild -i -uc -us -sa -S</code>
Once the package has been built, a <code>.changes</code> file will be created in
pbuilder's configured destination directory.</li>
<li>test the package (piuparts, Lintian, etc.)</li>
<li>sign the corresponding source.changes file
<code>debsign ../tails-installer_$NEW_UPSTREAM_RELEASE-xxx_source.changes</code>
Replace "xxx" with the correct version information.
The signature should be made with a key which is registered
at Launchpad as being part of the Tails team.</li>
<li>Upload to the PPA:
<code>dput ppa-tails-installer ../tails-installer_$NEW_UPSTREAM_RELEASE+xxx_source.changes</code></li>
</ul>


<p>You will receive an email informing you if the upload was really successful
or if it contained any errors. On success, you should now revert your changes on the
Debian branch using <code>git reset HEAD --hard</code>.</p>

<h2><a name="index10h2"></a>Quality assurance for Debian and Ubuntu packages</h2>

<pre><code>Scenario: Installing Tails to a pristine USB drive
  Given I have started Debian
  And I have a Tails ISO image
  When I install the tails-installer package
  And I plug USB drive "install"
  And I ask Tails Installer to install my Tails ISO image to USB drive "install"
  Then my Tails ISO image is installed on USB drive "install"

Scenario: Upgrading an old Tails USB installation from an ISO image
  Given I have started Debian
  And I have a Tails ISO image
  When I install the tails-installer package
  And I plug USB drive "upgrade" that has an old Tails installed
  And I ask Tails installer to upgrade USB drive "upgrade" with my Tails ISO image
  Then my Tails ISO image is installed on USB drive "upgrade"
</code></pre>

</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="./liveusb-creator.html">liveusb-creator</a>

<a href="../release_process.html">release process</a>


</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/release_process/tails-installer">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
