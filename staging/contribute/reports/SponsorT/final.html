<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Tails final report on reproducible builds</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../../style.css" type="text/css" />

<link rel="stylesheet" href="../../../local.css" type="text/css" />


<script src="../../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../../../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../../../index.en.html"><img src="../../../lib/home.png"></a></li>







<li><a href="../../../contribute.en.html">contribute</a></li>





<li><a href="../../reports.html">reports</a></li>





<li><a href="../SponsorT.html">SponsorT</a></li>




<li>Tails final report on reproducible builds</li>

</ul>
</span>
<span class="title">
Tails final report on reproducible builds
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../../../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../../../about.en.html">About</a></li>
    <li><a href="../../../getting_started.en.html">Getting started…</a></li>
    <li><a href="../../../doc.en.html">Documentation</a></li>
    <li><a href="../../../support.en.html">Help &amp; Support</a></li>
    <li><a href="../../../contribute.en.html">Contribute</a></li>
    <li><a href="../../../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">


<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Current status</a>
	</li>
	<li class="L1"><a href="#index2h1">Technical details</a>
	<ol>
		<li class="L2"><a href="#index1h2">Reproducible website build</a>
		</li>
		<li class="L2"><a href="#index2h2">Translations</a>
		</li>
		<li class="L2"><a href="#index3h2">A serious blocker: fontconfig</a>
		</li>
		<li class="L2"><a href="#index4h2">Automatic upgrades</a>
		</li>
		<li class="L2"><a href="#index5h2">User documentation</a>
		</li>
		<li class="L2"><a href="#index6h2">Build infrastructure</a>
		</li>
		<li class="L2"><a href="#index7h2">Test infrastructure</a>
		</li>
		<li class="L2"><a href="#index8h2">How does one read these tests?</a>
		</li>
		<li class="L2"><a href="#index9h2">Release process documentation</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index3h1">Working with the broader free software community</a>
	<ol>
		<li class="L2"><a href="#index10h2">Upstream contributions</a>
		</li>
		<li class="L2"><a href="#index11h2">Explanations for the Reproducible Builds community</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index4h1">Conclusion</a>
	</li>
</ol>
</div>


<p>This is the final report about making Tails reproducible as part of the
Mozilla Open Source Support award (MOSS).</p>

<h1><a name="index1h1"></a>Current status</h1>

<p>In March 2017 we first <a href="../../../news/report_2017_03.html">reported</a> that we had
finally seen an ISO image build reproducibly on several machines. Since
then we kept working on this front, and solved one after the other every
non-deterministic element of the build process.</p>

<p>As of January 2018, Tails ISO images are fully reproducible.
<a href="https://labs.riseup.net/code/issues/14933">#14933</a> was our last blocker and has been resolved.
We've released a reproducible Tails ISO image this month (Tails 3.4).</p>

<p>We are also proud to announce that we went even further and managed to
make our automatic upgrades (IUKs or Incremental Upgrade Kits)
reproducible as well!</p>

<p>We think that reproducible Tails ISO images preventively improve the
resilience to backdoors by making it much riskier to either compromise
our infrastructure or pressure our developers.</p>

<h1><a name="index2h1"></a>Technical details</h1>

<h2><a name="index1h2"></a>Reproducible website build</h2>

<p>As we include a copy of our website, which serves as our documentation for
users, into our ISO images, we ought to make our website software, ''ikiwiki'',
as well as the translations of this documentation, build reproducibly.  In
March 2017 we've made great progress to get the website build reproducibly.
Later on, we realized that ''ikiwiki'' resized some images of our website which
sometimes contained timestamped metadata, thus making the ISO image build
non-reproducibly again. We have worked around this on our side (<a href="https://labs.riseup.net/code/issues/12566">#12566</a>) and then we have contributed upstream a fix for the root cause of this
problem in ''ikiwiki'' (<a href="https://labs.riseup.net/code/issues/12625">#12625</a>); this was merged upstream.</p>

<p>We also fixed how ikiwiki handles dates in our blog posts <a href="https://labs.riseup.net/code/issues/12726">#12726</a> and fixed incorrect metadata in old blog posts and their
translations (<a href="https://labs.riseup.net/code/issues/11966">#11966</a> – who would have guessed this
affected build determinism? :)</p>

<h2><a name="index2h2"></a>Translations</h2>

<p>We fixed our script that refreshes the website's translation files so
that it won't update PO files unless something other than POT-Creation-Date
has changed (<a href="https://labs.riseup.net/code/issues/11967">#11967</a>). We later encountered and fixed
more problems with comments in POT files (<a href="https://labs.riseup.net/code/issues/12641">#12641</a>).</p>

<h2><a name="index3h2"></a>A serious blocker: fontconfig</h2>

<p>The cloud which was hiding the blue skies and the sun in the reproducible
builds solar system for several weeks was ''fontconfig'': We ship a cache for
fonts in Tails.  However, this cache was not generated in a reproducible
manner. In March we tried moving its generation out of the ISO, however, it
makes Tails start slower and resulted in too many unreliable test failures.
Thus, we decided to move it back into the ISO image and to try and fix the root
cause of the problem instead. We filed <a href="https://bugs.debian.org/863427">Debian bug #863427</a>, but we already know
that our patch is not yet enough to fix the problem, although it greatly
reduces the number of differences from 75 to 5 (<a href="https://labs.riseup.net/code/issues/12567">#12567</a>). At
the beginning of June, we finally solved this last blocker, and are upstreaming
our patches to Debian, so that other projects may profit from these
improvements.</p>

<h2><a name="index4h2"></a>Automatic upgrades</h2>

<p>Our automatic upgrades are now reproducible (<a href="https://labs.riseup.net/code/issues/12630">#12630</a>).</p>

<p>When we generate the ISO image using isohybrid, we pass it an ID. We
tried setting this ID to <code>$SOURCE_DATE_EPOCH</code> which resulted in a
reproducible, but non-hybrid, ISO because <code>$SOURCE_DATE_EPOCH</code> is an
invalid value for that ID. Thus, we decided to pass a fixed and valid ID
instead: <a href="https://labs.riseup.net/code/issues/12453">#12453</a>.</p>

<h2><a name="index5h2"></a>User documentation</h2>

<p>Reproducible builds fill the critical gap between the free source code and the
distributed binaries. Thus, the political objective of free software to reclaim
the power to control our software and computing is not limited anymore to the
minority of people building their own binaries.</p>

<p>For those of our users who want to verify their own ISO builds against ours,
we documented how to do that (<a href="https://labs.riseup.net/code/issues/12630">#12630</a>).</p>

<p>In November 2017, we published a blog post to explain to our users <a href="../../../news/reproducible_Tails.en.html">what
reproducible builds are</a>)
in a non-technical manner, by using the recipe cooking analogy.</p>

<h3><a name="index1h3"></a>How does one verify that a self-built ISO image is indeed reproducible?</h3>

<p>By making the Tails ISO images build reproducibly, we have achieved our goal to
improve user security by making it possible to verify the binary that we are
distributing.</p>

<p>It's pretty simple: With each ISO image we release, and from now on, we'll
release images that we've already tested upon reproducibility (except
in rare, exceptional emergency cases and only if the root cause for
non-reproducibly has been proven to be harmless); we also release
a PGP signature. Users who build their own ISO images can, from now on, download
this signature and simply verify it against their own ISO image. It should
match.</p>

<p>We've published <a href="../../build/reproducible.html#verify-iso">the verification procedure in
detail</a>.</p>

<h2><a name="index6h2"></a>Build infrastructure</h2>

<p>We planned to describe and publish our build environments in order to make
our infrastructure and distribution processes more transparent. Thus, the
possibility of public scrutiny and trust in our software development and
release process finds itself greatly increased.</p>

<p>After a long discussion, we <a href="https://labs.riseup.net/code/issues/12409">decided</a> not
to publish any Vagrant basebox at all: the key argument in favour of
this major design change was to remove one huge binary blob from the
list of trusted inputs needed for building a Tails ISO image.
This will substantially increase the value of Tails ISO images
building reproducibly. This decision has a few nice side effects,
including:</p>

<ul>
<li>the properties of the basebox required to build a given state of our
code base are entirely encoded in the corresponding Git commit;</li>
<li>changes in the ISO build box definition don't require building and
uploading a new basebox.</li>
</ul>


<p>Then we made enough progress to migrate our Continuous Integration
platform to the build system used by developers. This is now running
in production. For details, see <a href="https://labs.riseup.net/code/issues/11972">#11972</a>,
<a href="https://labs.riseup.net/code/issues/11979">#11979</a>, <a href="https://labs.riseup.net/code/issues/11980">#11980</a>,
<a href="https://labs.riseup.net/code/issues/11981">#11981</a>, <a href="https://labs.riseup.net/code/issues/12017">#12017</a>, and
<a href="https://labs.riseup.net/code/issues/11006">#11006</a>.</p>

<p>Then we had to deal with a number of issues that we were not in
a position to identify before submitting this brand new system to
a real-world workload. Most of them were fixed already
(<a href="https://labs.riseup.net/code/issues/12530">#12530</a>, <a href="https://labs.riseup.net/code/issues/12578">#12578</a>,
<a href="https://labs.riseup.net/code/issues/12565">#12565</a>, <a href="https://labs.riseup.net/code/issues/12541">#12541</a>,
<a href="https://labs.riseup.net/code/issues/12529">#12529</a>, <a href="https://labs.riseup.net/code/issues/12575">#12575</a>,
<a href="https://labs.riseup.net/code/issues/12606">#12606</a>). Work is still in progress on some other
problems: they are our Continuous Integration engineers' top priority,
and should be fully resolved in the next couple of months.</p>

<p>We documented this and publish a design documentation in October 2017
<a href="https://labs.riseup.net/code/issues/12616">#12616</a>.</p>

<p>Our <a href="../../build.html">build instructions</a> have
been updated and this will make it easier for people who want to build
and verify Tails ISO images to do exactly that.</p>

<h2><a name="index7h2"></a>Test infrastructure</h2>

<p>Our QA and testing processes have been greatly improved as the build of our
development branches is now more deterministic, and the automated tests that we
perform on these branches as we dvelop new features have been updated to match
this fact. Because they now include the output of ''diffoscope'', we can always
verify that no new feature or new software package introduces a regression on
reproducibility.</p>

<p>In order to test if an ISO image is indeed reproducible, we vary our test
environment. The build environment variations we've tested include: build
system clock (last month, next month, next year), number of
CPU cores, CPU brand and model, building in Vagrant or not.</p>

<p>Our automatic build infrastructure now always builds two ISO images, both from
the same commit, this means, that both builds use identical input, and then
compares them using ''diffoscope''.</p>

<p>This way, we ensure that we'll identify build reproducibility issues
as early as possible in our development process. Furthermore, this
also makes it possible for
each developer to build an ISO image locally on their machine and to compare
this image with the one build either by other developers, or by our
ISO builders.</p>

<p>Besides these modifications which were necessary, we also worked on improving
the tools we use for testing and comparing ISOs. For example, we made
''diffoscope'' <em>way</em> faster when comparing SquashFS'es. This work was done
directly upstream.</p>

<p>Finally, we have <a href="https://labs.riseup.net/code/issues/12579">set up</a> automated tests for the
reproducibility of our ISO image. Obviously, the results of these tests <a href="https://nightly.tails.boum.org/reproducibly_build_Tails_ISO_devel/builds/">are
publicly
available</a>.</p>

<h2><a name="index8h2"></a>How does one read these tests?</h2>

<p>Every attempt to reproducibly rebuild an ISO generates a second ISO image, as
well as a number of files, which help
identify the build environment and its' variables.  These files are the so
called "build artifacts". If the two ISO images are not identical, one will find the output
of diffoscope, a comparison tool, in the build_artifacts. If this file is not
present, there are not differences detected by our test environment, and thus,
a build is reproducible. These successful reproduction attempts are <a href="https://nightly.tails.boum.org/reproducibly_build_Tails_ISO_devel/builds/lastSuccessfulBuild/">found
here</a>.</p>

<h2><a name="index9h2"></a>Release process documentation</h2>

<p>We are still working on documenting how we've modified our release
process to ensure the ISO images we publish are reproducible
(<a href="https://labs.riseup.net/code/issues/12628">#12628</a>, <a href="https://labs.riseup.net/code/issues/12629">#12629</a>). The documentation
will be published when Tails 3.5 is out (January 2018).</p>

<h1><a name="index3h1"></a>Working with the broader free software community</h1>

<h2><a name="index10h2"></a>Upstream contributions</h2>

<p>All the code that we wrote during this project has either been published in
our Git tree, or, when improvements were made to upstream software or
projects, has been upstreamed.  This is the case for our changes in
''fontconfig'', ''ikiwiki'', ''squashfs'' and ''diffoscope'', for example.
We certainly hope that this will help other projects to rely on our
improvements.</p>

<p>For example:</p>

<ul>
<li>APT auto-removal file (<a href="https://labs.riseup.net/code/issues/11986">#11986</a>): patch submitted and accepted
upstream, backported in Tails</li>
<li>Switched to the new squashfs-tools upstream, that builds SquashFS
in a reproducible manner (<a href="https://labs.riseup.net/code/issues/12032">#12032</a>).</li>
<li>Various non-determinism issues in the mtimes of the files included
in our SquashFS, that made not only the SquashFS non-reproducible,
but also made the initrd non-reproducible despite the patches we
sent upstream for initramfs-tools (<a href="https://labs.riseup.net/code/issues/12330">#12330</a>).</li>
</ul>


<h2><a name="index11h2"></a>Explanations for the Reproducible Builds community</h2>

<p>In October we also published <span class="createlink">a technical report on how we made Tails
images
reproducible</span>
and sent it to the <a href="https://lists.reproducible-builds.org/pipermail/rb-general/2017-October/000656.html">Reproducible Builds general
mailinglist</a></p>

<p>During the third Reproducible Builds World summit, which took place in November
2017 in Berlin, we generalized this report and contributed everything we
know about making system images reproducible to the <a href="https://reproducible-builds.org/docs/system-images/">Reproducible Builds
documentation</a>.</p>

<h1><a name="index4h1"></a>Conclusion</h1>

<p>Working on making Tails reproducible was a fun endeavor and we are very
happy to having been supported by MOSS! Thank you.</p>

</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">












</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/reports/SponsorT/final">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
