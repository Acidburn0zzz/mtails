[[!meta title="Network connection (configuration and startup)"]]

This is about [[!tails_ticket 10491]].

[[!toc levels=2]]

Current issues in Tails
=======================

* A. After Tails Greeter, it might be hard for some people to understand where
  to click on the GNOME desktop to connect a Wi-Fi network.

  Cf. Eileen's feedback.

* B. It's impossible to go from direct Tor connection to bridge mode in case
  you realize once in the session that you actually need them to connect.

* C. It's hard to know whether you need to log in through a captive portal.
  [[!tails_ticket 5785 desc="Detect captive portals"]]

* D. There's no way of triggering Tor to reconnect after logging in through a
  captive portal, except by closing the Unsafe Browser (which is not obvious).

* E. Once cannot set up bridges if they need the Unsafe Browser (to log into a captive
  portal or to get bridges), if they close
  the Unsafe Browser (that restarts Tor which breaks Tor Launcher).
  Too bad, for non-bridge use cases one has to close the Unsafe Browser
  to make Tor connect. [[!tails_ticket 11535]]

* F. It can be scary for people who cannot afford
  connecting without obfuscated PTs (to hide they're using Tor) to postpone
  this choice after the session is started.

* G. Bridges, firewall and proxy have to be configured again each time.
  [[!tails_ticket 5461 desc="Persistence preset: Tor configuration"]]

* H. It's not clear how one is supposed to get bridges if they need some.

* I. One can't get bridges automatically if one needs some to connect.

* J. There is no visual feedback on whether the connection to Tor is making
 progress.

* K. If MAC spoofing fails but I decide that it's OK not to spoof MAC in my
  situation, then I have to reboot Tails all the way.

* L. [[!tails_ticket 15635 desc="The Unsafe Browser allows to retrieve the public IP address by a compromised amnesia user with no user interaction"]]

* M. [[!tails_ticket 16795 desc="No audio in Unsafe Browser"]]

* N. People use the Unsafe Browser to browser the Internet

* O. A persistent network connection is associated to a specific network interface
  (via its MAC address) so it cannot be reused easily when hoping between computers
  with one's Tails. [[!tails_ticket 10803]]

Open questions
==============

  - What's left from this configuration process on the desktop after Tor is
    started?
    - What do we do with the NetworkManager in GNOME Shell?
    - Do we allow changing or visualizing the current settings?

  - What's the best way of asking for bridges, keeping in mind
    situations where people might be at risk if they don't use them?
    - Lunar's proposal: Say you're at risk in the Greeter, then configure
      bridges in the session.
    - other possibility: Do everything in the session (offline mode and MAC
      spoofing could still be optional settings in the Greeter), if so how?
    - if we have persistent network configuration (for example bridges) per
      local network, then this might conflict (or duplicate) the fact of
      asking about bridges in the Greeter
    - bridges might be needed on a given local network but not on
      another, would it be possible to ask about that *after* selecting
      the local network?

  - Could we, technically speaking, do something more useful about the failure
    of MAC spoofing than disabling the interface? in the Greeter? in the session?
    - Should we ask for confirmation before disabling the interface?

  - How shall we integrate the captive portal browser on the desktop in case we
    need to get back to it (to log in again, to log out)?
    - Lunar's proposal: as a detached windows
    - other possibility: invisible browser by default, can be displayed again somehow

  - Do we want to tell people about entry guards? For example, feedback
    the entry guard to be selected before connecting? Random entry
    guards are bad for security but persistent entry guards can ease
    tracking.

  - Is it OK to be more fingerprintable by checking (without Tor) whether
    a captive portal is sitting in the way?

  - Is it OK actively try to connect directly (without bridges), then via
    regular bridges, then via obfuscated PTs, to discover
    whether bridges/PTs are needed? How do we keep supporting "I need to hide
    the fact I'm using Tor" if we do so?

  - Related question: how much is Tails fingerprintable _as Tails_ by a network
    attacker (ISP), as opposed to being fingerprintable as "someone using Tor Browser"?

  - How do we instruct Network Manager not to attempt DHCP on known networks?
    This particularly matters for the wired interface because this autoconnection
    would happen even without persistence, and even on network we've never connected to.
    That's relevant only once we've moved MAC spoofing from global to per-network.

  - In the current mockups, to use a wired DHCP connection or a Wi-Fi network saved in persistence with the default
    settings (direct Tor, MAC spoofing), one needs to click twice. While
    in current Tails, it works automatically with no user interaction.
    Both have pros and cons.

    Idea: Add "Autoconnect" toggle in screens 2 and 13.

Out of scope
============

- Adversary who blocks access to the captive portal they control once they notice
  you're using Tor: they can as well forbid your MAC address from connecting to
  they Wi-Fi AP.

- People who have to disable MAC spoofing all the time as this is pretty
  uncommon, cf. [[!tails_ticket 16385#note-5]]. As long as they can do this manually
  for each new Wi-Fi network they connect to (compared to doing it manually
  every time they start Tails, currently), that will be good enough.


Process
=======

- Original post-its by Lunar:
  - <https://labs.riseup.net/code/attachments/download/1250/2015.10.02.jpg>
  - <https://mailman.boum.org/pipermail/tails-dev/2015-October/009593.html>

- Digital rewrite by Spencer:
  - <https://labs.riseup.net/code/attachments/download/1251/2015.12.04.png>
  - <https://mailman.boum.org/pipermail/tails-ux/2015-December/000812.html>

<a id="iff"></a>

- We had a session at the IFF to gather feedback on mockups. See [[!tails_ticket 11245]].
  - [flowchart behind the mockups](https://labs.riseup.net/code/attachments/download/1293/network-20160306.odg)
  - [mockups](https://tails.boum.org/contribute/how/promote/material/slides/IFF-20160306/)
  - [feedback from post-if notes](https://labs.riseup.net/code/attachments/download/1291/iff-feedback.ods)

Iterations
==========

1. Enable "bridge mode" by default and remove it from the Greeter
   That is, start Tor Launcher on every connection to a network,
   if we never successfully connected to tor during this session,
   or if our last attempt to connect to tor during this session failed.

   - Solves issues: B, J.
   - Bonus points: makes UX closer to the one in regular Tor Browser.
   - Worsens issues: F (temporarily and for 1st time users affected by issue F,
     until they understand that the new behaviour behaves by default, all of
     the time, in they way they had to opt-in for previously).
     → Add a temporary note about the change in Tails Greeter.
   - Cost: seems rather cheap to implement; only issue may be how to
     tell Tor Launcher that last settings failed and it needs to
     prompt for manual config again.

2. Persistent Tor settings

   - Solves issues: G.

   Shall they be global or per-network? Per-network is vastly harder
   to implement and makes UX more complex. Per-network could be useful
   for:
    - I want to hide I use Tor for *this* place → solved by iteration
      1: as long as Tor Launcher pops up and I get to choose whether
      I want to diverge from my usual, persistent settings.
    - I need to use a proxy when I'm in *this* place → solved by
      iteration 1 (same as above).
    - The ISP in *this* place blocks Tor and I'd rather not use bridges
      everywhere else as I don't need them (but it does not hurt much)
      → solved by iteration 1 (same as above).

   In any case, the user needs to be allowed to revisit their choices
   that were persisted.

 - Replace GNOME UI to connect to new networks with our own.
   Is this still useful given iterations 1 and 2 dismiss the per-network settings approach?
   Or can we skip the "select a network" step of our mockups and jump to the
   "Tor configuration mode" once we've connected to a network?

 - Option "I want to hide the fact that I'm using Tails and use Tor bridges on every network." in screen 1
   or in Tor Launcher.
   - So we can jump to manual Tor configuration directly.
   - So we can avoid probing captive portals too early.

 - Move "Disable networking" and MAC spoofing from global (Greeter) to per-network.
   Optional, can happen at the end or never, not needed by anything else.
   Probably the hardest to get right on the implementation side.

Related work
============

  - [[Captive portal detection|detect_captive_portals]]

At Tor
------

  - Tor Launcher can now retrieve bridges automatically ("Moat") [[!tails_ticket 15331]]
  - Tor Browser might soon discover (by trial & error) whether one needs bridges/PTs.
    This breaks the "hide that I'm using Tor" use case but makes things easier
    for everyone else. This should happen in their nightlies between 2020-09 and 2021-09.
  - [A Usability Evaluation of Tor Launcher](https://trac.torproject.org/projects/tor/wiki/doc/TorLauncherUX2016)
  - [UX testing of circumvention features of Tor Browser](https://github.com/lindanlee/circumvention-ux-tor)
  - <https://github.com/lindanlee/PETS2017-paper/blob/master/lindas-ms-paper/lindas-ms-paper.pdf>
  - Tor UX team's design of new Tor launcher: <https://marvelapp.com/3f6102d>
  - [Feedback on design decision for Tor Launcher](https://lists.torproject.org/pipermail/tbb-dev/2017-February/000473.html)
    discussion on the tbb-dev mailing list (spread over 2017-02 and 2017-03)

At Whonix
---------

  - <https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/303>
  - <https://github.com/irykoon/anon-connection-wizard>
    (or: <https://github.com/Whonix/anon-connection-wizard>)
