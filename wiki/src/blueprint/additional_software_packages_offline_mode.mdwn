This is about [[!tails_ticket 14570]] which we plan to implement for Tails 3.5.

# Goal

Have Additional software packages to work offline forever, but to upgrade when connecting to the Internet.

# Current status

According to [[!tails_ticket 6260]] Additional Software Packages works offline for a dew days after being connected, but then fails.

We researched the possible root causes of this class of issues and
identified three:

## APT indices have expired

This was the hypothesis on [[!tails_ticket 6260]].

Release file corresponding to the packages to be installed is expired.
This is controlled by the `Valid-Until` field of the Release file
(<https://wiki.debian.org/DebianRepository/Format#Date.2C_Valid-Until>).

Looking at Valid-Until fields on Tails, it seems to be :

- ~1 week for unstable and stable/update
- ~1 month for torproject.org
- unlimited for stable

Testing and study of the APT source code show that this problem does
not exist anymore on Tails 3.3: APT checks the indices expiration date
only when it downloads them, not when it reads them to
install packages.

## One of the packages was not cached in the first place

   ([[!tails_ticket 10958]])

## Incomplete online upgrade process

Assume that during an online Tails session, the APT indices are
successfully updated, but then Tails is shut down before the upgraded
Debian packages were downloaded. Then, if Tails is started offline the
next time, the packages that needed to be upgraded cannot
be installed.

# Reproduction procedure

I tried installing packages offline in Tails 3.3 using the following procedure on 14 Dec 2017:

* start Tails online with persistence of apt packages and apt lists
* install optipng (currently pulled from stretch/updates, which expires on 22 Dec 2017) and wdiff (from stretch, which doesn't expire) and add them to additional software list
* reboot offline
* the install works and optipng version is the one from stretch/updates
* set the date 1 year in the future in the BIOS
* reboot offline
* the install works and optipng version is the one from stretch/updates

I went through the entire procedure 3 times and got the same results. Basic offline operation is thus already working, and [[!tails_ticket 6260]] seems to be already resolved : recent APT doesn't check Valid-Until on package installation.

# Possible solutions

## Don't check Valid-Until on installation

Disable release file validity test on installation (Acquire::Check-Valid-Until=false). We could test if we are offline before doing that. We would still do the validity check on upgrade.

## Apt-offline

<https://labs.riseup.net/code/issues/7208>

## Local repository

Use a local repository to store the packages (e.g. https://help.ubuntu.com/community/Repositories/Personal). We control our Release file, but importing and upgrading the repository looks annoying.
