[[!meta title="Time-based snapshots of upstream APT repositories"]]

[[!toc levels=2]]

Overview
========

XXX: import relevant content from
<https://tails.boum.org/blueprint/freezable_APT_repository/>

These are _full_ snapshots of the upstream APT repositories we use for
building Tails ISO images. They contain exactly the same set of
packages as the mirrored repository. This has the advantage that some
workflows are trivially handled, e.g. working on a topic branch that
installs additional Debian packages; if such snapshots were not full
ones, then to work on one such branch, one would need either that to
have the credentials to import new packages from Debian into our own
mirror or repositories (which raises the barrier for contributing), or
that during some phases of Tails development the regular Debian
archive is used instead of our own mirror, which feels prone to "time
to QA vs. time to release" issues.

We snapshot each upstream APT repository N times a day, and without
further action, each snapshot is kept for D days.

The main goal here is to be able to freeze the APT repositories used
by a branch, whenever we freeze it.

The corresponding data is not critical: we can restart the whole thing
from scratch if needed, without too much pain â‡’ no need to synchronize
this content to the failover server; no need to back it up.

# Source code

* `tails::reprepro::snapshots::time_based` class in
  [[!tails_gitweb_repo puppet-tails]]
* bits scattered in the main Tails Git repository (details below)

Workflow
========

<a id="bump-expiration-date"></a>

Bump expiration date
--------------------

XXX: script was renamed, usage and behavior might have changed

We set `Valid-Until` of time-based snapshots 10 days after they are
generated. In some rare cases, e.g. if a freeze lasts substantially
longer than usual, this can be too short, and we may need to manually
bump `Valid-Until` for a given time-based snapshot.

Only release managers and sysadmins can do such operations.

To bump `Valid-Until` to `$VALID_UNTIL`, for all distributions in
a given snapshot (`$SERIAL`) of a given archive (`$ARCHIVE`):

	ssh time.snapshots.deb.tails.boum.org \
	   sudo -u reprepro-time-based-snapshots \
	      /usr/local/bin/postpone-apt-snapshot-expiration \
	         "$ARCHIVE" "$SERIAL" "$VALID_UNTIL"

To bump `Valid-Until` to `$VALID_UNTIL`, for all distributions in
every snapshot used by the current frozen `testing` branch:

	git checkout testing && \
	(
	   cd config/APT_snapshots.d/* && \
	   for ARCHIVE in * ; do
	      ssh time.snapshots.deb.tails.boum.org \
	         sudo -u reprepro-time-based-snapshots \
	            /usr/local/bin/postpone-apt-snapshot-expiration \
	               "$ARCHIVE" "$(cat "$ARCHIVE"/serial)" "$VALID_UNTIL"
	   done
	)

For additional, up-to-date information about the
`postpone-apt-snapshot-expiration` command:

	ssh time.snapshots.deb.tails.boum.org \
	   sudo /usr/local/bin/postpone-apt-snapshot-expiration --help
