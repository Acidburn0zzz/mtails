[[!meta title="Trusted verification of reproducibility"]]

[[!toc levels=2]]

# Preparation

## Inputs

You will need some environment variables set when following these
instructions.

### Inputs received be email

You should receive values for the following variables:

* `DIST`
* `IUK_CHECKOUT_TAG`
* `IUK_SOURCE_VERSIONS`
* `TAG`
* `TAG_COMMIT`
* `VERSION`

as well as a `SHA512SUMS.txt` file attached.

### Your inputs

Set these variables according to the beginning of our
[[contribute/release_process]] document:

* `ARTIFACTS`
* `ISOS`
* `IUK_CHECKOUT`

Also set these accordingly:

* `ISOS_CHECKOUT`: path to your Tails ISO history repo checout.
* `PUBLISHED_ARTIFACTS`: some _new_ directory where you can download
  gigabytes of data to.
* `SHA512SUMS`: the path of the `SHA512SUMS.txt` file from above.
* `TAILS_CHECKOUT`: path to your Tails Git repo checkout.

## Download published products

    mkdir -p "${PUBLISHED_ARTIFACTS:?}" && \
    cd "${PUBLISHED_ARTIFACTS:?}" && \
    mkdir tails-amd64-${VERSION:?} && \
    cd tails-amd64-${VERSION:?} && \
    wget --recursive http://dl.amnesia.boum.org/tails/${DIST:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso && \
    cd .. && \
    for old_version in ${IUK_SOURCE_VERSIONS}; do
        wget http://dl.amnesia.boum.org/tails/${DIST:?}/iuk/Tails_amd64_${old_version}_to_${VERSION:?}.iuk
    done

## Obtain needed old Tails releases

    cd "${ISOS_CHECKOUT:?}" && \
    git annex sync && \
    for old_version in ${IUK_SOURCE_VERSIONS:?}; do
        tails_dir="tails-amd64-${old_version}" && \
        if [ ! -d "${ISOS:?}/${tails_dir}" ];  then
            git annex get "${tails_dir}" && \
            cp -r "${tails_dir}" "${ISOS:?}"
        fi
    done

## Refresh tails-iuk Git repo

    cd "${IUK_CHECKOUT:?}" && \
    git fetch && \
    git checkout "${IUK_CHECKOUT_TAG:?}"

# Reproduce Tails

## Fetch and verify the Git tag

    cd "${TAILS_CHECKOUT:?}" && \
    git fetch && \
    git checkout "${TAG_COMMIT:?}" && \
    if [ "$(git describe --tags --exact-match)" = "${TAG:?}" ]; then
        git tag -v "${TAG}"
    else
        echo 'TAG_COMMIT and TAG does not match!'
    fi

* If the last output is a "Good signature" for the expected tag, made by
  Tails signing key, then we are good.

* Otherwise, if you see _anything_ else, we're _not_ good; immediately
  contact the RM and tails@! Proceeding with the rest of the steps
  are pointless in this case, so await instruction.

## Reproduce the image

    export SOURCE_DATE_EPOCH=$(date --utc --date="$(dpkg-parsechangelog --show-field=Date)" '+%s') && \
    rake build && \
    mkdir "${ISOS:?}/tails-amd64-${VERSION:?}" && \
	    mv "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.iso" \
       "${ISOS:?}/tails-amd64-${VERSION:?}/"

## Reproduce IUKs

Follow the [[Build the Incremental Upgrade
Kits|contribute/release_process/#prepare-iuk]] instructions. Note that
the value of `SOURCE_DATE_EPOCH` set above is needed!

# Verification

If there is *any* type of mismatch at some point below, let the RM and
tails@ know *immediately*!

## Verify your products

    cd "${ISOS:?}" && \
    sha512sum -c "${SHA512SUMS:?}"

## Verify published products

    cd "${PUBLISHED_ARTIFACTS:?}" && \
    sha512sum -c "${SHA512SUMS:?}"

## Verify IDF

Examine the IDF by running:

    curl https://tails.boum.org/install/v1/Tails/amd64/${DIST:?}/latest.yml

and checking that:

* the `url` value is the expected ISO image URL, i.e.:

      http://dl.amnesia.boum.org/tails/${DIST:?}/tails-amd64-$VERSION/tails-amd64-$VERSION.iso

* the `sha256` value is the `SHA-256` you get from your image (with
  e.g. `sha256sum`).

* the `size` value is the number of bytes of your image.

## Verify UDFs

Examine each UDF by running:

    for old_version in ${IUK_SOURCE_VERSIONS}; do
        url=https://tails.boum.org/upgrade/v1/Tails/${old_version}/amd64/${DIST:?}/upgrades.yml
        (
            echo "Looking at '${url}':"
            echo
            curl --silent --show-error ${url}
        ) | less
    done

and checking that there are either one or two `target-files`
entries, where `type: full` means a full upgrade (so it refers to
the ISO image) and `type: incremental` means an incremental upgrade
(so it refers to a IUK). Verify

* that the `url` is

      http://dl.amnesia.boum.org/tails/${DIST:?}/iuk/Tails_amd64_${old_version}_to_$$VERSION.iuk

* the `sha256` and `size` values just like you did for the IDF previously.
