#!/bin/sh

set -e
set -u

PERSISTENT_DATA_DIR=/home/amnesia/Persistent
OLD_DB="${PERSISTENT_DATA_DIR}/keepassx.kdb"
MIGRATED_DB="${PERSISTENT_DATA_DIR}/New database.kdbx"
NEW_DB="${PERSISTENT_DATA_DIR}/keepassx.kdbx"

if mountpoint -q "$PERSISTENT_DATA_DIR"; then
	# Move to the Persistent folder to save the migrated database in the
	# right folder by default.
	cd "$PERSISTENT_DATA_DIR"

	# Move the already migrated data to the right place
	if [ -e "$MIGRATED_DB" ]; then
		mv "$MIGRATED_DB" "$NEW_DB"
	fi

	# Start the migration from the old KeePassX database to the new format
	# used in Stretch.
	if [ -e "$OLD_DB" ] && [ ! -e "$NEW_DB" ]; then
		cp /home/amnesia/.config/keepassx/keepassx2.ini /tmp/
		/usr/bin/keepassx "$OLD_DB"
		mv /tmp/keepassx2.ini /home/amnesia/.config/keepassx/
	else
		/usr/bin/keepassx
	fi
else
	/usr/bin/keepassx
fi
