#!/bin/sh

set -e
set -u
set -x

. gettext.sh
TEXTDOMAIN="tails"
export TEXTDOMAIN

# Import set_mozilla_pref()
. /usr/local/lib/tails-shell-library/tor-browser.sh

THUNDERBIRD_CONFIG_DIR="${HOME}/.thunderbird"
PROFILE="${THUNDERBIRD_CONFIG_DIR}/profile.default"

thunderbird_config_is_persistent() {
    [ "$(findmnt --noheadings --output SOURCE --target "${THUNDERBIRD_CONFIG_DIR}")" = "/dev/mapper/TailsData_unlocked[/thunderbird]" ]
}

configure_locale() {
    # Thunderbird will set the locale based on the environment when
    # this pref is empty, but will then save the result to this pref
    # disabling this "guess" for the next time. We want Thunderbird to
    # always match the locale of the Tails session.
    set_mozilla_pref "${PROFILE}/prefs.js"   \
                     "intl.locale.requested" \
                     '""'                    \
                     user_pref
}

prompt_for_disable_autocrypt() {
    local server="${1}"
    local dialog_msg="`eval_gettext \"<b><big>Do you want disable Autocrypt?</big></b>

You have Autocrypt enabled for <i>\\\${server}</i>.
Autocrypt is a quite new feature, that should help you encrypting without even think about it.
In the past, there were cases, where unencrypted messages were sent unexpectitly.
Tails recommend to disable Autocrypt for the moment, but you can still keep it enabled, if you know what you do.

Do you want to disable Autocrypt for <i>\\\${server}</i>?\"`
"
    local disable="`gettext \"Disable\"`"
    local keep="`gettext \"Keep enabled\"`"
    zenity --question --title "" --text "${dialog_msg}" --default-ok \
           --ok-label "${disable}" --cancel-label "${keep}"
}

disable_autocrypt() {
    # Disable Autocrypt since it is not safe (#15923).
    set_mozilla_pref "${PROFILE}/prefs.js"                 \
                     "mail.server.default.enableAutocrypt" \
                     "false"                               \
                     user_pref

    # Search all accounts, where Autocrypt is enabled and ask for disable Autocrypt.
    enabledAccountsAutocrypt=`sed -n -E 's/.*\("mail\.server\.(server[0-9]+)\.enableAutocrypt"\s*,\s*true\s*\);\s*/\1/p' "${PROFILE}/prefs.js"`
    for server in ${enabledAccountsAutocrypt}; do
        if prompt_for_disable_autocrypt "${server}"; then
            set_mozilla_pref "${PROFILE}/prefs.js"                   \
                             "mail.server.${server}.enableAutocrypt" \
                             "false"                                 \
                             user_pref
        fi
    done
}

configure_default_incoming_protocol() {
    # For extensions.torbirdy.defaultprotocol, POP = 0, IMAP = 1
    local default_protocol
    if thunderbird_config_is_persistent; then
        default_protocol=0
    else
        default_protocol=1
    fi
    set_mozilla_pref "${PROFILE}/prefs.js"                 \
                     "extensions.torbirdy.defaultprotocol" \
                     "${default_protocol}"                 \
                     user_pref
}

reconfigure_profile() {
    mkdir -p "${PROFILE}"
    configure_locale
    disable_autocrypt
    configure_default_incoming_protocol

    # Suppress Enigmail's configuration wizard by pretending that the current
    # version was already configured. Only do this on first run though:
    # once we've done this we let Enigmail manage this setting itself
    # so it can run any migration code it wants to on upgrades.
    if thunderbird_profile_is_new; then
	initialize_enigmail_configured_version
    fi
}

thunderbird_profile_is_new() {
   [ ! -f "${PROFILE}/extensions.json" ]
}

initialize_enigmail_configured_version() {
    mkdir -p "${PROFILE}/preferences"
    version="$(dpkg-query --show \
                          --showformat='${source:Upstream-Version}' \
                          enigmail | sed -E 's,\+.*$,,')"
    # Set the value in prefs.js so that Enigmail can manage it itself
    # once we've done this once.
    set_mozilla_pref "${PROFILE}/prefs.js" \
                     "extensions.enigmail.configuredVersion" \
                     "\"${version}\"" \
		     'user_pref'
}

start_thunderbird() {
    export GNOME_ACCESSIBILITY=1
    unset SESSION_MANAGER
    reconfigure_profile
    exec /usr/bin/thunderbird --class "Thunderbird" -profile "${PROFILE}" "${@}"
}

start_thunderbird "${@}"
