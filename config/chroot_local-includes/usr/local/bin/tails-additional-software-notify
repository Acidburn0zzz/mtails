#!/usr/bin/env python3

import gettext
import os
import os.path
import sys

import gi

from gi.repository import GLib

gi.require_version('Notify', '0.7')
from gi.repository import Notify                                # NOQA: E402

_ = gettext.gettext


class ASPNotifier(object):
    """Display a notification and exit with a meaningful code."""

    def __init__(self, title, body, accept_label=None, deny_label=None,
                 urgent=False):
        """Shows a notification with two optional action buttons.

        If there are no buttons, exit straight away with a meaningful code.
        """
        Notify.init("org.boum.tails.additional-software-packages")

        # We need to hold a reference to the notification until the callbacks
        # are called. That's why we use an instance variable.
        self.notification = Notify.Notification.new(
                title, body, icon="package-x-generic")
        if urgent:
            self.notification.set_urgency(Notify.Urgency.CRITICAL)
        if deny_label:
            self.notification.add_action("deny", deny_label,
                                         self.cb_notification_clicked, None)
        if accept_label:
            self.notification.add_action("accept", accept_label,
                                         self.cb_notification_clicked, None)
        self.notification.connect("closed", self.cb_notification_closed)
        self.notification.show()
        sys.stdout.write("id=%i" % self.notification.props.id)
        if not accept_label:
            sys.exit(3)

    def cb_notification_clicked(self, notification, action, user_data=None):
        """Exit the program with a meaningful code on action triggering."""
        if action == "accept":
            sys.exit(0)
        elif action == "deny":
            sys.exit(3)

    def cb_notification_closed(self, notification):
        """Exit the program with a meaningful code on notification close."""
        sys.exit(4)


def print_help():
    """The subcommand which displays help
    """
    program_name = os.path.basename(sys.argv[0])
    sys.stderr.write(
        "Usage: %s <summary> <body> [<accept_label> [<deny_label> "
        "[<urgent>]]]\n" % program_name)
    sys.stderr.write(
        "Shows a notification with <summary>, <body> and two optional "
        "buttons.\n"
        "\n"
        "Returns: 0 if <accept_label> is selected\n"
        "         2 if the number of arguments is wrong\n"
        "         3 if <deny_label> is selected\n"
        "         4 if the notification is closed another way\n")


if __name__ == "__main__":
    os.environ["DBUS_SESSION_BUS_ADDRESS"] = \
        "unix:path=/run/user/{uid}/bus".format(uid=os.getuid())

    gettext.install("tails")

    if not 3 <= len(sys.argv) <= 6:
        print_help()
        sys.exit(2)

    mainloop = GLib.MainLoop.new(None, False)
    ASPNotifier(*sys.argv[1:])
    mainloop.run()
