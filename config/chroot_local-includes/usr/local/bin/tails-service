#!/usr/bin/env python3

import sys
import os
import logging

from tails_server import argument_parser
from tails_server import util
import tails_server.services

service_names = tails_server.services.service_names
service_module_paths = tails_server.services.service_module_paths
service_modules_dict = tails_server.services.import_service_modules()
services = [module.service_class() for module in service_modules_dict.values()]


def list_services():
    for service in service_names:
        print("-", service)


def list_enabled():
    enabled_services = [service for service in services if service.is_running]
    for service in enabled_services:
        print("-", service.name)


def autostart_services():
    """Start services with the autostart option set to True"""
    autostart_services = [
        service for service in services
        if "autostart" in service.options_dict and service.options_dict["autostart"].value
    ]
    for service in autostart_services:
        logging.info("Starting service %r", service.name)
        util.run_threaded(service.enable)


def init(args):
    if args.verbose:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)
    logging.debug("args: %r", args)


def exec_service(args):
    service_module_path = service_module_paths[args.SERVICE]
    del args.SERVICE
    os.execv(service_module_path, [service_module_path] + sys.argv[1:-1])


def main():
    args = argument_parser.WrapperParser().parse_args()
    init(args)

    if args.command == "list":
        list_services()
    elif args.command == "list-enabled":
        list_enabled()
    elif args.command == "autostart":
        autostart_services()
    else:
        if os.geteuid() != 0:
            exit("This command requires root")
        exec_service(args)


if __name__ == "__main__":
    main()