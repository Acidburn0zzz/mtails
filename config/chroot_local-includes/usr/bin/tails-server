#!/usr/bin/env python3

import argparse
import logging

import sh
from gi.repository import Gtk

from tails_server.gui.service import ServiceStatus
from tails_server.gui.gui import TailsServerGUI

sh.ErrorReturnCode.truncate_cap = 5000


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("--log-file", "-l", default="/var/log/tails-server.log")
    parser.add_argument("--verbose", "-v", action="count")
    return parser.parse_args()


def init(args):
    if not args.verbose:
        level = logging.INFO
    elif args.verbose == 1:
        level = logging.DEBUG
    else:
        level = 0
    if args.log_file:
        logging.basicConfig(filename=args.log_file, level=level)
        logging.getLogger().addHandler(logging.StreamHandler())
    else:
        logging.basicConfig(level=level)
    logging.getLogger('stem').setLevel(level)
    logging.debug("args: %r", args)


def main():
    args = parse_args()
    init(args)
    ServiceStatus.register_signal()
    TailsServerGUI()
    Gtk.main()

if __name__ == "__main__":
    main()
