#!/bin/sh

PREREQS=""

prereqs() { echo "$PREREQS"; }

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

set -u
set -e

# Print executed commands for debugging
[ -n "$debug" ] && set -x

. /scripts/functions

if [ -z "${FSUUID}" ]; then
   echo "\$FSUUID is unset, probably because the boot medium is an ISO." \
        "Skipping update-seed."
   exit 0
fi

log_begin_msg "Writing new random seed to bootloader config"
SEED="$(hexdump -n 512 -e '"%02X"' /dev/urandom)"
sed -E -i \
    "s/(\s+)append(\s+)(randomseed=\S+\s)?/\1append\2randomseed=${SEED} /g" \
    "${rootmnt}/lib/live/mount/medium/syslinux/live64.cfg" \
    "${rootmnt}/lib/live/mount/medium/EFI/BOOT/live64.cfg"
log_end_msg

exit 0
