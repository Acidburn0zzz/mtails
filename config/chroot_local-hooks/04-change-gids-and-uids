#!/bin/sh

set -e

# Free the fixed GIDs and UIDs we're using.

echo "Change GIDs and UIDs"

Change_uid () {
	OLD="$1"
	NEW="$2"
	NAME=$(getent passwd "$OLD" | awk -F ':' '{print $1}')

	if [ -n "$NAME" ]; then
		echo "Changing UID for $NAME ($OLD -> $NEW)"
		usermod --uid "$NEW" "$NAME"
		find / -wholename /proc -prune -o \( \! -type l -a -uid "$OLD" -exec chown "$NEW" '{}' \; \)
	fi
}

Change_gid () {
	OLD="$1"
	NEW="$2"
	NAME=$(getent group "$OLD" | awk -F ':' '{print $1}')

	if [ -n "$NAME" ]; then
		echo "Changing GID for $NAME ($OLD -> $NEW)"
		groupmod --gid "$NEW" "$NAME"
		find / -wholename /proc -prune -o \( \! -type l -a -gid "$OLD" -exec chgrp "$NEW" '{}' \; \)
	fi
}


# tails-persistent-setup
Change_uid 115 150
Change_gid 122 150
