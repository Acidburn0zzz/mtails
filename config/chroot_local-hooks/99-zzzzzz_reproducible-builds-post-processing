#! /bin/sh

set -e

echo "Post processing filesystem to make it reproducible"

if [ -z "${SOURCE_DATE_EPOCH}" ]; then
    echo "SOURCE_DATE_EPOCH was not set!" >&2
    exit 1
fi

# These files are pretty useless for us and mainly occupy space on the
# image. They are, for instance, not useful for checking the
# authenticity of the filesystem (an external verification tool and
# source of these checksums would be required), and checking for
# corruption is less relevant in Tails' context, where the system
# partition is read-only (the point being: if they do differ, chances
# are problems would manifest in much more obvious ways).
rm /var/lib/dpkg/info/*.md5sums

# Clear caches and remove precompiled code. These will be generated
# on-the-fly when needed instead of being shipped on the image, so
# we'll require a bit more RAM and startup times, while the image will
# be smaller (and more reproducible!).
rm /etc/ssl/certs/java/cacerts
rm /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server/classes.jsa
rm /var/cache/fontconfig/*
rm /var/cache/ldconfig/aux-cache
rm /var/lib/monkeysphere/authentication/core/private-keys-v1.d/*.key
rm /var/lib/systemd/catalog/database

# Delete various non-deterministically generated files that will be
# generated on the fly (at boot, or when needed) any way.
rm /etc/machine-id

# Remove logs.
rm -r /var/lib/dkms/*/*/*/*/log

# Set various timestamps according to SOURCE_DATE_EPOCH.
find / -name '%gconf-tree.xml' -print0 | \
    xargs -0r \
        sed -i -e 's@\bmtime="[0-9][0-9]*"@mtime="'${SOURCE_DATE_EPOCH}'"@g'

# Clamp mtimes. Note that we pass `-xdev` to exclude e.g. /proc and
# /sys where we would fail.
# Note: this should be the last thing we do in this file!
find / -xdev -newermt "@${SOURCE_DATE_EPOCH}" -print0 | \
    xargs -0r \
        touch --no-dereference --date="@${SOURCE_DATE_EPOCH}"
