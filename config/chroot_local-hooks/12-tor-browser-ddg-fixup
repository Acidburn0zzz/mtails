#!/bin/sh

# This hook backports the only relevant fix introduced in -build7,
# which later was released as Tor Browser 6.0.6.

set -e

echo "Add DDG search plugin fixup to Tor Browser 6.0.6-build6"

# Import the TBB_INSTALL variable and supported_tor_browser_locales()
. /usr/local/lib/tails-shell-library/tor-browser.sh

# Import strip_nondeterminism_wrapper()
. /usr/local/lib/tails-shell-library/build.sh

OMNI="${TBB_INSTALL}/browser/omni.ja"
TMP="$(mktemp -d)"
DDG="chrome/en-US/locale/browser/searchplugins/ddg.xml"
7z x -o"${TMP}" "${OMNI}" "${DDG}"
sed -i 's@<Url type="text/html" method="POST" template="https://duckduckgo.com/">@<Url type="text/html" method="POST" template="https://duckduckgo.com/html">@' "${TMP}/${DDG}"
( cd "${TMP}" ; 7z u -mtc=off -tzip "${OMNI}" . )
tbb_timestamp="$(date --utc --date='2000-01-01 00:00:00' +%s)"
strip_nondeterminism_wrapper --type zip --timestamp "${tbb_timestamp}" \
                             "${OMNI}" 2>/dev/null
chmod a+r "${OMNI}"
rm -r "${TMP}"
